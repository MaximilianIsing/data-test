<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Saved Colleges - Path Pal">
  <title>Saved Colleges - Path Pal</title>
  <link rel="manifest" href="/manifest.json">
  <link rel="stylesheet" href="/css/style.css">
  <meta name="theme-color" content="#0d8c79">
</head>
<body>
  <div class="desktop-message">
    <h1><img src="/media/icons/Mobile256x256.png" alt="Mobile" style="width: 48px; height: 48px; vertical-align: middle; margin-right: 0.5rem;"> Mobile App Required</h1>
    <p>Path Pal is designed for mobile devices. Please open this site on your mobile phone or tablet.</p>
  </div>

  <header>
    <div class="header-content container">
      <div class="logo">
        <a href="/index.html" style="display: flex; align-items: center; gap: 0.5rem; text-decoration: none; color: inherit;">
          <img src="/media/logo/logo64x64.png" alt="Path Pal Logo">
          <h1>Path Pal</h1>
        </a>
      </div>
      <button class="menu-toggle" aria-label="Toggle menu"><img src="/media/icons/Hamburger128x128.png" alt="Menu" style="width: 24px; height: 24px;"></button>
    </div>
  </header>

  <nav>
    <ul>
      <li><a href="/index.html"><img src="/media/icons/Home256x256.png" alt="Home" class="nav-icon"> Home</a></li>
      <li><a href="/profile.html"><img src="/media/icons/Profile256x256.png" alt="Profile" class="nav-icon"> My Profile</a></li>
      <li><a href="/odds.html"><img src="/media/icons/Odds256x256.png" alt="Admissions Odds" class="nav-icon"> Admissions Odds</a></li>
      <li><a href="/simulator.html"><img src="/media/icons/WhatIf256x256.png" alt="What If" class="nav-icon"> "What If" Simulator</a></li>
      <li><a href="/explorer.html"><img src="/media/icons/Search256x256.png" alt="College Explorer" class="nav-icon"> College Explorer</a></li>
      <li><a href="/career.html"><img src="/media/icons/DollarSign256x256.png" alt="Career & Salary Paths" class="nav-icon"> Career & Salary Paths</a></li>
      <li><a href="/activities.html"><img src="/media/icons/Activity256x256.png" alt="Activities" class="nav-icon"> Activity & Internship Recs</a></li>
      <li><a href="/planner.html"><img src="/media/icons/Calender256x256.png" alt="4-Year Planner" class="nav-icon"> 4-Year Planner</a></li>
      <li><a href="/messages.html"><img src="/media/icons/Chat256x256.png" alt="AI Counselor" class="nav-icon"> AI Counselor</a></li>
      <li><a href="/saved.html" class="active"><img src="/media/icons/Star256x256.png" alt="Saved Colleges" class="nav-icon"> Saved Colleges</a></li>
    </ul>
  </nav>

  <main>
    <div class="container">
      <h2 style="color: var(--primary-green); margin: 1rem 0;">Saved Colleges</h2>

      <div class="card">
        <p>Your bookmarked colleges and progress toward admission. Receive updates if requirements or acceptance trends change.</p>
        <button class="btn btn-secondary" onclick="window.location.href='/explorer.html'" style="width: 100%; margin-top: 1rem;">
          Explore More Colleges
        </button>
      </div>

      <!-- Saved Colleges List -->
      <div id="saved-colleges-list">
        <p class="loading">Loading saved colleges...</p>
      </div>

      <!-- Progress Tracking -->
      <div class="card" id="progress-card" style="display: none;">
        <h3>Application Progress</h3>
        <div id="progress-content"></div>
      </div>
    </div>
  </main>

  <footer>
    <div class="container">
      <p>&copy; 2025 Path Pal. v1.07</p>
    </div>
  </footer>

  <script src="/js/api.js"></script>
  <script src="/js/app.js"></script>
  <script>
    // Client-side implementation of getAdmissionOdds (from rate-system.js)
    function getAdmissionOdds(studentScore, collegeScore) {
      // Parse inputs
      const student = typeof studentScore === 'string' ? parseFloat(studentScore) : (studentScore || 0);
      const college = typeof collegeScore === 'string' ? parseFloat(collegeScore) : (collegeScore || 0);

      // Ensure scores are in valid range
      const studentNorm = Math.max(0, Math.min(100, student));
      const collegeNorm = Math.max(0, Math.min(100, college));

      // Calculate delta (difference)
      const delta = studentNorm - collegeNorm;

      // Base odds when scores are equal
      const baseOdds = 50; // 50% when student matches college

      // Use a sigmoid-like curve for smooth transitions
      const deltaMultiplier = 1.5; // Each point of delta = 1.5% change
      
      // Apply sigmoid-like curve for more realistic distribution
      const sigmoidFactor = 0.8; // Smoothing factor
      const normalizedDelta = delta / 50; // Normalize to -1 to 1 range
      const sigmoidDelta = (normalizedDelta / (1 + Math.abs(normalizedDelta) * sigmoidFactor)) * 50;
      let odds = baseOdds + (sigmoidDelta * deltaMultiplier);

      // Clamp to reasonable bounds (3% to 97%)
      odds = Math.max(3, Math.min(97, odds));

      // Round to nearest integer
      return Math.round(odds);
    }

    function categorizeSchool(odds) {
      if (odds === null || odds === undefined) return { category: 'unknown', label: 'Unknown' };
      if (odds >= 70) return { category: 'safety', label: 'Safety' };
      if (odds >= 40) return { category: 'target', label: 'Target' };
      return { category: 'reach', label: 'Reach' };
    }

    document.addEventListener('DOMContentLoaded', async () => {
      await initializeUserId();
      loadSavedColleges();
    });

    async function loadSavedColleges() {
      const savedColleges = SavedColleges.get();
      const profile = await UserProfile.get();
      const container = document.getElementById('saved-colleges-list');

      // Get student rating (only exists if profile is complete)
      const studentRating = (profile.rating !== null && profile.rating !== undefined && profile.rating !== '') 
        ? profile.rating 
        : null;

      if (savedColleges.length === 0) {
        container.innerHTML = `
          <div class="card">
            <h3 style="color: var(--primary-green); margin-bottom: 1rem;">No Saved Colleges Yet</h3>
            <p>Start exploring colleges and save your favorites to track your progress toward admission.</p>
            <button class="btn btn-primary" onclick="window.location.href='/explorer.html'" style="width: 100%; margin-top: 1rem;">
              Explore Colleges
            </button>
          </div>
        `;
        document.getElementById('progress-card').style.display = 'none';
        return;
      }

      container.innerHTML = '<h3 style="color: var(--primary-green); margin: 1rem 0;">Your Saved Colleges</h3>';

      savedColleges.forEach(college => {
        // Calculate admission odds using actual ratings
        let odds;
        let oddsDisplay;
        if (studentRating !== null && studentRating !== undefined && college.rating !== null && college.rating !== undefined) {
          odds = getAdmissionOdds(studentRating, college.rating);
          oddsDisplay = odds + '%';
        } else {
          odds = null;
          oddsDisplay = 'N/A';
        }
        const category = categorizeSchool(odds);
        
        const card = document.createElement('div');
        card.className = 'card';
        card.style.marginBottom = '1rem';
        card.id = `college-${college.id}`;
        
        card.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
            <div style="flex: 1;">
              <h4 style="color: var(--primary-green); margin-bottom: 0.5rem;">${college.name}</h4>
              <p style="color: var(--text-light); font-size: 0.9rem; margin-bottom: 0.25rem;"><img src="/media/icons/Location128x128.png" alt="Location" style="width: 16px; height: 16px; vertical-align: middle; margin-right: 0.25rem;"> ${college.location}</p>
              <p style="color: var(--text-light); font-size: 0.9rem; margin-bottom: 0.25rem;">${college.type} â€¢ ${college.size}</p>
              <p style="color: var(--text-light); font-size: 0.9rem;">Acceptance Rate: ${Math.round(college.acceptanceRate * 1000) /10}%</p>
            </div>
            <span class="badge badge-${category.category}">${category.label}</span>
          </div>
          
          <div style="background: var(--light-mint); padding: 1rem; border-radius: 8px; text-align: center; margin-bottom: 1rem;">
            <div style="font-size: 2rem; font-weight: bold; color: var(--primary-green);">${oddsDisplay}</div>
            <div style="color: var(--text-light); font-size: 0.85rem;">Your Admission Odds</div>
          </div>

          <div style="margin-bottom: 1rem;">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: bold; color: var(--text-dark);">Application Status</label>
            <select class="application-status" data-college-id="${college.id}" onchange="updateApplicationStatus('${college.id}', this.value)" style="width: 100%; padding: 0.75rem; border: 2px solid var(--border-color); border-radius: 8px; font-family: 'Arvo', serif;">
              <option value="not-started">Not Started</option>
              <option value="in-progress">In Progress</option>
              <option value="submitted">Submitted</option>
              <option value="accepted">Accepted</option>
              <option value="rejected">Rejected</option>
              <option value="waitlisted">Waitlisted</option>
            </select>
          </div>
          
          <div style="display: flex; gap: 0.5rem;">
            <button class="btn btn-secondary" onclick="window.location.href='/simulator.html'" style="flex: 1;">
              Test Changes
            </button>
            <button class="btn btn-secondary" onclick="removeCollege('${college.id}')" style="flex: 1; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
              <span>Unsave</span>
              <img src="/media/icons/StarFull256x256.png" alt="Unsave" style="width: 20px; height: 20px;">
            </button>
          </div>
        `;
        
        // Load saved status (convert ID to string for consistent matching)
        const savedStatus = Storage.get('applicationStatuses', {});
        const statusSelect = card.querySelector('.application-status');
        const collegeIdStr = String(college.id);
        if (statusSelect && savedStatus[collegeIdStr]) {
          statusSelect.value = savedStatus[collegeIdStr];
        }
        
        container.appendChild(card);
      });

      loadProgressTracking(savedColleges);
    }

    function removeCollege(collegeId) {
      // Convert to string if it's a number to ensure consistent ID matching
      const id = String(collegeId);
      SavedColleges.remove(id);
      loadSavedColleges();
      showNotification('College removed from saved list.', 'info');
    }

    function updateApplicationStatus(collegeId, status) {
      // Convert to string if it's a number to ensure consistent ID matching
      const id = String(collegeId);
      const statuses = Storage.get('applicationStatuses', {});
      statuses[id] = status;
      Storage.set('applicationStatuses', statuses);
      
      // Update the progress tracking without reloading everything
      const savedColleges = SavedColleges.get();
      loadProgressTracking(savedColleges);
      showNotification('Application status updated!', 'success');
    }

    function loadProgressTracking(savedColleges) {
      const card = document.getElementById('progress-card');
      const container = document.getElementById('progress-content');
      const statuses = Storage.get('applicationStatuses', {});

      const stats = {
        'not-started': 0,
        'in-progress': 0,
        'submitted': 0,
        'accepted': 0,
        'rejected': 0,
        'waitlisted': 0
      };

      savedColleges.forEach(college => {
        const collegeIdStr = String(college.id);
        const status = statuses[collegeIdStr] || 'not-started';
        stats[status] = (stats[status] || 0) + 1;
      });

      const total = savedColleges.length;
      const completed = stats.submitted + stats.accepted + stats.rejected + stats.waitlisted;
      const completionRate = total > 0 ? (completed / total) * 100 : 0;

      container.innerHTML = `
        <div style="background: var(--light-mint); padding: 1rem; border-radius: 8px; margin-bottom: 1rem; text-align: center;">
          <div style="font-size: 2rem; font-weight: bold; color: var(--primary-green);">${completionRate.toFixed(0)}%</div>
          <div style="color: var(--text-light); font-size: 0.9rem;">Applications Completed</div>
        </div>

        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem;">
          <div style="padding: 0.75rem; background: var(--light-mint); border-radius: 8px; text-align: center;">
            <div style="font-size: 1.5rem; font-weight: bold; color: var(--primary-green);">${stats.accepted}</div>
            <div style="font-size: 0.85rem; color: var(--text-light);">Accepted</div>
          </div>
          <div style="padding: 0.75rem; background: var(--light-mint); border-radius: 8px; text-align: center;">
            <div style="font-size: 1.5rem; font-weight: bold; color: var(--warning);">${stats['in-progress']}</div>
            <div style="font-size: 0.85rem; color: var(--text-light);">In Progress</div>
          </div>
          <div style="padding: 0.75rem; background: var(--light-mint); border-radius: 8px; text-align: center;">
            <div style="font-size: 1.5rem; font-weight: bold; color: var(--primary-green);">${stats.submitted}</div>
            <div style="font-size: 0.85rem; color: var(--text-light);">Submitted</div>
          </div>
          <div style="padding: 0.75rem; background: var(--light-mint); border-radius: 8px; text-align: center;">
            <div style="font-size: 1.5rem; font-weight: bold; color: var(--text-light);">${stats['not-started']}</div>
            <div style="font-size: 0.85rem; color: var(--text-light);">Not Started</div>
          </div>
        </div>
      `;

      card.style.display = 'block';
    }

    // Check for updates
    function checkForUpdates() {
      // In a real app, this would check for updates to college requirements or acceptance trends
      // For now, just show a notification
      showNotification('Saved colleges are up to date!', 'success');
    }

    // Check updates on load
    setTimeout(checkForUpdates, 2000);
  </script>
</body>
</html>

