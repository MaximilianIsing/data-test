<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Admissions Odds - Path Pal">
  <title>Admissions Odds - Path Pal</title>
  <link rel="manifest" href="/manifest.json">
  <link rel="stylesheet" href="/css/style.css">
  <meta name="theme-color" content="#0d8c79">
</head>
<body>
  <div class="desktop-message">
    <h1><img src="/media/icons/Mobile256x256.png" alt="Mobile" style="width: 48px; height: 48px; vertical-align: middle; margin-right: 0.5rem;"> Mobile App Required</h1>
    <p>Path Pal is designed for mobile devices. Please open this site on your mobile phone or tablet.</p>
  </div>

  <header>
    <div class="header-content container">
      <div class="logo">
        <a href="/index.html" style="display: flex; align-items: center; gap: 0.5rem; text-decoration: none; color: inherit;">
        <img src="/media/logo/logo64x64.png" alt="Path Pal Logo">
        <h1>Path Pal</h1>
        </a>
      </div>
      <button class="menu-toggle" aria-label="Toggle menu"><img src="/media/icons/Hamburger128x128.png" alt="Menu" style="width: 24px; height: 24px;"></button>
    </div>
  </header>

  <nav>
    <ul>
      <li><a href="/index.html"><img src="/media/icons/Home256x256.png" alt="Home" class="nav-icon"> Home</a></li>
      <li><a href="/profile.html"><img src="/media/icons/Profile256x256.png" alt="Profile" class="nav-icon"> My Profile</a></li>
      <li><a href="/odds.html" class="active"><img src="/media/icons/Odds256x256.png" alt="Admissions Odds" class="nav-icon"> Admissions Odds</a></li>
      <li><a href="/simulator.html"><img src="/media/icons/WhatIf256x256.png" alt="What If" class="nav-icon"> "What If" Simulator</a></li>
      <li><a href="/explorer.html"><img src="/media/icons/Search256x256.png" alt="College Explorer" class="nav-icon"> College Explorer</a></li>
      <li><a href="/career.html"><img src="/media/icons/DollarSign256x256.png" alt="Career & Salary Paths" class="nav-icon"> Career & Salary Paths</a></li>
      <li><a href="/activities.html"><img src="/media/icons/Activity256x256.png" alt="Activities" class="nav-icon"> Activity & Internship Recs</a></li>
      <li><a href="/planner.html"><img src="/media/icons/Calender256x256.png" alt="4-Year Planner" class="nav-icon"> 4-Year Planner</a></li>
      <li><a href="/messages.html"><img src="/media/icons/Chat256x256.png" alt="AI Counselor" class="nav-icon"> AI Counselor</a></li>
      <li><a href="/saved.html"><img src="/media/icons/Star256x256.png" alt="Saved Colleges" class="nav-icon"> Saved Colleges</a></li>
      <li><a href="#" onclick="handleSignOut(); return false;"><img src="/media/icons/SignOut256x256.png" alt="Sign Out" class="nav-icon"> Sign Out</a></li>
      <li><a href="https://forms.gle/ULMYUSDifpanJ9KMA" target="_blank"><img src="/media/icons/Feedback256x256.png" alt="Feedback" class="nav-icon"> Feedback</a></li>
    </ul>
  </nav>

  <main>
    <div class="container">
      <h2 style="color: var(--primary-green); margin: 1rem 0;">Admissions Odds</h2>

      <div class="card">
        <p>Select colleges from your saved list or explore to see your acceptance odds based on your profile.</p>
        <button class="btn btn-secondary" onclick="window.location.href='/explorer.html'" style="margin-top: 1rem; width: 100%;">
          Explore Colleges
        </button>
      </div>

      <!-- Selected Colleges -->
      <div id="odds-results"></div>

      <!-- Profile Comparison Section -->
      <div class="card" id="profile-comparison" style="display: none;">
        <h3>Profile Comparison</h3>
        <div id="comparison-content"></div>
      </div>

      <!-- AI Tips Section -->
      <div class="card" id="ai-tips" style="display: none;">
        <h3 style="margin-bottom: 0.5rem;">AI Tips to Improve Your Odds</h3>
        <div id="tips-content" class="loading">Loading personalized tips...</div>
      </div>
    </div>
  </main>

  <footer>
    <div class="container">
      <p>&copy; Path Pal 2025 — v1.09</p>
    </div>
  </footer>

  <script src="/js/api.js"></script>
  <script src="/js/app.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      loadSavedCollegesOdds();
      loadAITips();
    });

    // Client-side implementation of getAdmissionOdds (from rate-system.js)
    function getAdmissionOdds(studentScore, collegeScore, acceptanceRate) {
      // Parse inputs
      const student = typeof studentScore === 'string' ? parseFloat(studentScore) : (studentScore || 0);
      const college = typeof collegeScore === 'string' ? parseFloat(collegeScore) : (collegeScore || 0);
      const acceptance = typeof acceptanceRate === 'string' ? parseFloat(acceptanceRate) : (acceptanceRate || null);

      // Ensure scores are in valid range
      const studentNorm = Math.max(0, Math.min(100, student));
      const collegeNorm = Math.max(0, Math.min(100, college));

      // Calculate delta (difference)
      const delta = studentNorm - collegeNorm;

      // Base odds when scores are equal - start from the college's acceptance rate if available
      // If no acceptance rate, default to 50%
      let baseOdds = 50;
      if (acceptance !== null && acceptance >= 0 && acceptance <= 1) {
        // Use acceptance rate as base, but adjust based on score delta
        // For example: 15% acceptance rate college = base odds of 15% when student matches college
        baseOdds = acceptance * 100;
      }

      // Calculate odds based on delta
      // Positive delta (student > college) = higher odds
      // Negative delta (student < college) = lower odds
      
      // Use a sigmoid-like curve for smooth transitions
      const deltaMultiplier = 1.5; // Each point of delta = 1.5% change
      let odds = baseOdds + (delta * deltaMultiplier);

      // Apply sigmoid-like curve for more realistic distribution
      // This makes extreme differences less impactful
      const sigmoidFactor = 0.8; // Smoothing factor
      const normalizedDelta = delta / 50; // Normalize to -1 to 1 range
      const sigmoidDelta = (normalizedDelta / (1 + Math.abs(normalizedDelta) * sigmoidFactor)) * 50;
      odds = baseOdds + (sigmoidDelta * deltaMultiplier);

      // If acceptance rate is provided, use it as a constraint
      // The odds should not exceed the acceptance rate by too much, and should scale with it
      if (acceptance !== null && acceptance >= 0 && acceptance <= 1) {
        const acceptancePercent = acceptance * 100;
        
        // Scale the odds relative to the acceptance rate
        // If baseOdds was set from acceptance rate, we've already accounted for it
        // But we should ensure odds don't go too far above/below the acceptance rate based on delta alone
        
        // For highly selective schools (low acceptance), limit how high odds can go
        if (acceptancePercent < 20) {
          // Very selective: odds can go up to 2.5x the acceptance rate for strong students
          const maxOdds = Math.min(acceptancePercent * 2.5, 95);
          odds = Math.min(odds, maxOdds);
        } else if (acceptancePercent < 50) {
          // Moderately selective: odds can go up to 1.8x the acceptance rate
          const maxOdds = Math.min(acceptancePercent * 1.8, 95);
          odds = Math.min(odds, maxOdds);
        } else {
          // Less selective: odds can go higher, but still cap at reasonable level
          const maxOdds = Math.min(acceptancePercent * 1.5, 95);
          odds = Math.min(odds, maxOdds);
        }
        
        // Ensure odds don't go below a minimum based on acceptance rate
        // Even weak students have some chance at less selective schools
        if (acceptancePercent > 50) {
          const minOdds = Math.max(acceptancePercent * 0.3, 5);
          odds = Math.max(odds, minOdds);
        } else {
          const minOdds = Math.max(acceptancePercent * 0.2, 2);
          odds = Math.max(odds, minOdds);
        }
      }

      // Clamp to reasonable bounds (2% to 98%)
      odds = Math.max(2, Math.min(98, odds));

      // Round to nearest integer
      return Math.round(odds);
    }

    function categorizeSchool(odds) {
      if (odds === null || odds === undefined) return { category: 'unknown', label: 'Unknown' };
      if (odds >= 70) return { category: 'safety', label: 'Safety' };
      if (odds >= 40) return { category: 'target', label: 'Target' };
      return { category: 'reach', label: 'Reach' };
    }

    async function loadSavedCollegesOdds() {
      const savedColleges = SavedColleges.get();
      const profile = await UserProfile.get();
      const container = document.getElementById('odds-results');

      if (savedColleges.length === 0) {
        container.innerHTML = `
          <div class="card">
            <p>No saved colleges yet. <a href="/explorer.html" style="color: var(--primary-green);">Explore colleges</a> and save them to see your admission odds.</p>
          </div>
        `;
        return;
      }

      container.innerHTML = '<h3 style="color: var(--primary-green); margin-bottom: 1rem;">Your Admission Odds</h3>';

      // Get student rating (only exists if profile is complete)
      const studentRating = (profile.rating !== null && profile.rating !== undefined && profile.rating !== '') 
        ? profile.rating 
        : null;

      savedColleges.forEach(college => {
        // Calculate admission odds using actual ratings
        let odds;
        let oddsDisplay;
        if (studentRating !== null && studentRating !== undefined && college.rating !== null && college.rating !== undefined) {
          odds = getAdmissionOdds(studentRating, college.rating, college.acceptanceRate);
          oddsDisplay = odds + '%';
        } else {
          odds = null;
          oddsDisplay = 'N/A';
        }
        const category = categorizeSchool(odds);
        
        const card = document.createElement('div');
        card.className = 'card';
        card.style.marginBottom = '1rem';
        
        card.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
            <div>
              <h3 style="color: var(--primary-green); margin-bottom: 0.5rem;">${college.name}</h3>
              <p style="color: var(--text-light); font-size: 0.9rem;">
                ${college.location} • ${college.type} • ${college.acceptanceRate !== null ? Math.round(college.acceptanceRate * 1000) / 10 + '%' : 'N/A'} acceptance
              </p>
            </div>
            ${odds !== null ? `<span class="badge badge-${category.category}">${category.label}</span>` : ''}
          </div>
          <div style="background: var(--light-mint); padding: 1rem; border-radius: 8px; text-align: center;">
            <div style="font-size: 2.5rem; font-weight: bold; color: var(--primary-green);">${oddsDisplay}</div>
            <div style="color: var(--text-light); font-size: 0.9rem;">Acceptance Probability</div>
          </div>
        `;
        
        container.appendChild(card);
      });
    }

    async function loadAITips() {
      const profile = await UserProfile.get();
      const savedColleges = SavedColleges.get();

      if (!profile.name || savedColleges.length === 0) {
        document.getElementById('ai-tips').style.display = 'none';
        return;
      }

      document.getElementById('ai-tips').style.display = 'block';
      const tipsContent = document.getElementById('tips-content');

      // Check if tips are saved locally
      const savedTips = localStorage.getItem('ai-tips');
      if (savedTips) {
        try {
          const tips = JSON.parse(savedTips);
          displayTips(tips);
          return; // Use saved tips, don't fetch new ones
        } catch (e) {
          // If parsing fails, continue to fetch new tips
        }
      }

      // Fetch new tips if not saved
      try {
        const message = `Based on my profile (GPA: ${profile.gpa || 'not set'}, SAT: ${profile.sat || 'not set'}, ACT: ${profile.act || 'not set'}, Grade: ${profile.grade || 'not set'}), what are 3-5 actionable suggestions to improve my admission odds for college? Be specific and concise.`;
        
        const response = await sendChatMessage(message);
        const tips = response.message.split('\n').filter(line => line.trim());
        
        // Save tips to localStorage
        localStorage.setItem('ai-tips', JSON.stringify(tips));
        
        displayTips(tips);
      } catch (error) {
        tipsContent.innerHTML = '<p style="color: var(--text-dark);">Unable to load tips at this time. Please try again later.</p>';
      }
    }

    function displayTips(tips) {
      const tipsContent = document.getElementById('tips-content');
      tipsContent.className = ''; // Remove loading class
      tipsContent.innerHTML = '<ul style="list-style: none; padding: 0; margin: 0; text-align: left;">' + 
        tips.map(tip => {
          const cleanTip = tip.trim().replace(/^[-•]\s*/, '').replace(/^\d+\.\s*/, '');
          return `<li style="padding: 0.75rem 0; border-bottom: 1px solid var(--border-color); color: var(--text-dark); text-align: left; line-height: 1.6;"><strong style="color: var(--primary-green);">•</strong> ${cleanTip}</li>`;
        }).join('') + 
        '</ul>';
    }
  </script>
  <script src="/js/auth.js"></script>
  <script>
    function handleSignOut() {
      signOut();
      window.location.href = '/pages/login.html';
    }
  </script>
</body>
</html>

