<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="My Profile - Path Pal">
  <title>My Profile - Path Pal</title>
  <link rel="manifest" href="/manifest.json">
  <link rel="stylesheet" href="/css/style.css">
  <meta name="theme-color" content="#0d8c79">
</head>
<body>
  <div class="desktop-message">
    <h1><img src="/media/icons/Mobile256x256.png" alt="Mobile" style="width: 48px; height: 48px; vertical-align: middle; margin-right: 0.5rem;"> Mobile App Required</h1>
    <p>Path Pal is designed for mobile devices. Please open this site on your mobile phone or tablet.</p>
  </div>

  <header>
    <div class="header-content container">
      <div class="logo">
        <a href="/index.html" style="display: flex; align-items: center; gap: 0.5rem; text-decoration: none; color: inherit;">
        <img src="/media/logo/logo64x64.png" alt="Path Pal Logo">
        <h1>Path Pal</h1>
        </a>
      </div>
      <button class="menu-toggle" aria-label="Toggle menu"><img src="/media/icons/Hamburger128x128.png" alt="Menu" style="width: 24px; height: 24px;"></button>
    </div>
  </header>

  <nav>
    <ul>
      <li><a href="/index.html"><img src="/media/icons/Home256x256.png" alt="Home" class="nav-icon"> Home</a></li>
      <li><a href="/profile.html" class="active"><img src="/media/icons/Profile256x256.png" alt="Profile" class="nav-icon"> My Profile</a></li>
      <li><a href="/odds.html"><img src="/media/icons/Odds256x256.png" alt="Admissions Odds" class="nav-icon"> Admissions Odds</a></li>
      <li><a href="/simulator.html"><img src="/media/icons/WhatIf256x256.png" alt="What If" class="nav-icon"> "What If" Simulator</a></li>
      <li><a href="/explorer.html"><img src="/media/icons/Search256x256.png" alt="College Explorer" class="nav-icon"> College Explorer</a></li>
      <li><a href="/career.html"><img src="/media/icons/DollarSign256x256.png" alt="Career & Salary Paths" class="nav-icon"> Career & Salary Paths</a></li>
      <li><a href="/activities.html"><img src="/media/icons/Activity256x256.png" alt="Activities" class="nav-icon"> Activity & Internship Recs</a></li>
      <li><a href="/planner.html"><img src="/media/icons/Calender256x256.png" alt="4-Year Planner" class="nav-icon"> 4-Year Planner</a></li>
      <li><a href="/messages.html"><img src="/media/icons/Chat256x256.png" alt="AI Counselor" class="nav-icon"> AI Counselor</a></li>
      <li><a href="/saved.html"><img src="/media/icons/Star256x256.png" alt="Saved Colleges" class="nav-icon"> Saved Colleges</a></li>
      <li><a href="#" onclick="handleSignOut(); return false;"><img src="/media/icons/SignOut256x256.png" alt="Sign Out" class="nav-icon"> Sign Out</a></li>
      <li><a href="https://forms.gle/ULMYUSDifpanJ9KMA" target="_blank"><img src="/media/icons/Feedback256x256.png" alt="Feedback" class="nav-icon"> Feedback</a></li>
    </ul>
  </nav>

  <main>
    <div class="container">
      <h2 style="color: var(--primary-green); margin: 1rem 0;">My Profile</h2>

      <!-- Profile Overview -->
      <div class="card">
        <div class="profile-header" style="text-align: center; margin-bottom: 1.5rem;">
          <div style="position: relative; display: inline-block; margin-bottom: 1rem;">
            <div id="profile-picture-container" style="width: 100px; height: 100px; background: var(--light-mint); border-radius: 50%; margin: 0 auto; display: flex; align-items: center; justify-content: center; overflow: hidden; border: 3px solid var(--primary-green);">
              <img id="profile-picture" src="/media/icons/Profile256x256.png" alt="Profile" style="width: 100%; height: 100%; object-fit: cover; display: none;">
              <img id="profile-picture-placeholder" src="/media/icons/Profile256x256.png" alt="Profile" style="width: 64px; height: 64px;">
            </div>
            <label for="profile-picture-input" style="position: absolute; bottom: 0; right: 0; background: var(--light-mint); border: 2px solid var(--primary-green); border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.2);">
              <img src="/media/icons/Camera256x256.png" alt="Camera" style="width: 20px; height: 20px;">
              <input type="file" id="profile-picture-input" accept="image/*" style="display: none;">
            </label>
          </div>
          <h2 id="profile-name" style="color: var(--primary-green);">Student Name</h2>
        </div>

        <div class="form-group">
          <label>Name</label>
          <input type="text" id="name" placeholder="Enter your name" maxlength="40">
        </div>

        <div class="form-group">
          <label>Current Grade</label>
          <select id="grade">
            <option value="">Select grade</option>
            <option value="9th">9th Grade</option>
            <option value="10th">10th Grade</option>
            <option value="11th">11th Grade</option>
            <option value="12th">12th Grade</option>
          </select>
        </div>
      </div>

      <!-- Academic Info -->
      <div class="card">
        <h3>Academic Information</h3>
        
        <div class="form-group">
          <label>
            GPA
            <span style="font-weight: normal; font-size: 0.8rem; color: var(--text-light); margin-left: 0.25rem;">
              (approximate if unknown)
            </span>
          </label>
          <input type="number" id="gpa" step="0.01" min="0" max="5" placeholder="e.g., 3.75">
        </div>

        <div class="form-group">
          <label>
            <input type="checkbox" id="weighted" style="width: auto; margin-right: 0.5rem;">
            Weighted GPA
          </label>
        </div>

        <div class="form-group">
          <label>Test Type</label>
          <select id="test-type">
            <option value="">Select test</option>
            <option value="UNTAKEN">Untaken</option>
            <option value="SAT">SAT</option>
            <option value="ACT">ACT</option>
            <option value="PSAT">PSAT</option>
          </select>
        </div>

        <!-- SAT fields -->
        <div id="sat-fields" class="test-section" style="display: none;">
          <div class="form-row">
            <div class="form-group">
              <label>SAT English</label>
              <input type="number" id="sat-reading" min="200" max="800" placeholder="e.g., 720">
            </div>
            <div class="form-group">
              <label>SAT Math</label>
              <input type="number" id="sat-math" min="200" max="800" placeholder="e.g., 740">
            </div>
          </div>
          <div class="form-group">
            <small>
              SAT Score (400-1600): <span id="sat-total"><strong>—</strong></span><br>
              <span style="color: var(--text-light);">Note: Path Pal treats this as a superscore using your best section scores.</span>
            </small>
          </div>
        </div>

        <!-- PSAT fields -->
        <div id="psat-fields" class="test-section" style="display: none;">
        <div class="form-row">
          <div class="form-group">
              <label>PSAT English</label>
              <input type="number" id="psat-reading" min="160" max="760" placeholder="e.g., 690">
            </div>
            <div class="form-group">
              <label>PSAT Math</label>
              <input type="number" id="psat-math" min="160" max="760" placeholder="e.g., 700">
            </div>
          </div>
          <div class="form-group">
            <small>
              PSAT Score (320-1520): <span id="psat-total"><strong>—</strong></span><br>
              <span style="color: var(--text-light);">Note: Path Pal treats this as a superscore using your best section scores.</span>
            </small>
          </div>
        </div>

        <!-- ACT fields -->
        <div id="act-fields" class="test-section" style="display: none;">
          <div class="form-row">
            <div class="form-group">
              <label>ACT English</label>
              <input type="number" id="act-english" min="1" max="36" placeholder="e.g., 34">
            </div>
            <div class="form-group">
              <label>ACT Math</label>
              <input type="number" id="act-math" min="1" max="36" placeholder="e.g., 32">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>ACT Reading</label>
              <input type="number" id="act-reading" min="1" max="36" placeholder="e.g., 35">
            </div>
            <div class="form-group">
              <label>ACT Science</label>
              <input type="number" id="act-science" min="1" max="36" placeholder="e.g., 33">
              <small style="display:block; margin-top:0.25rem; color: var(--text-light);">(optional)</small>
            </div>
          </div>
        <div class="form-group">
            <small>
              ACT Score (1-36): <span id="act-composite"><strong>—</strong></span><br>
              <span style="color: var(--text-light);">Note: Path Pal treats this as a superscore using your best section scores.</span>
            </small>
          </div>
        </div>

        <!-- AP Courses -->
        <div class="form-group" style="margin-top: 1.5rem;">
          <label>AP Courses Taken</label>
          <select id="ap-count">
            <option value="0">0</option>
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
            <option value="6">6</option>
            <option value="7">7</option>
            <option value="8">8</option>
            <option value="9">9</option>
          </select>
          <small style="display:block; margin-top:0.25rem; color: var(--text-light);">Add up to 9 AP classes and your exam scores.</small>
        </div>

        <div id="ap-table" style="margin-top: 0.5rem;">
          <!-- Rows will be rendered here -->
        </div>
      </div>

      <!-- Intended Majors -->
      <div class="card">
        <h3>Intended Majors</h3>
        <div class="form-group">
          <label>Select your intended major(s)</label>
          <div id="majors-container" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem; margin-top: 0.5rem; max-height: 200px; overflow-y: auto; align-items: center;">
            <!-- Major options will be rendered here -->
          </div>
          <small style="display: block; margin-top: 0.5rem;">You may select up to 3.</small>
        </div>
        <div id="selected-majors" style="margin-top: 1rem;"></div>
      </div>

      <!-- Activities & Interests -->
      <div class="card">
        <h3>Activities & Interests</h3>

        <!-- Extracurriculars in Common App-style format -->
        <div class="form-group">
          <label>Extracurricular Activities</label>
          <select id="activities-count">
            <option value="0">0</option>
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
            <option value="6">6</option>
            <option value="7">7</option>
            <option value="8">8</option>
            <option value="9">9</option>
            <option value="10">10</option>
          </select>
          <small style="display:block; margin-top:0.25rem; color: var(--text-light);">
            Report up to 10 key activities. Select frequency for each.
          </small>
        </div>

        <div id="activities-table" style="margin-top: 0.5rem;">
          <!-- Activity rows rendered here -->
        </div>

        <div class="form-group" style="margin-top: 1.5rem;">
          <label>Career Goals</label>
          <textarea id="career-goals" rows="3" maxlength="1000" placeholder="What are your career aspirations?"></textarea>
        </div>
      </div>

      <div class="save-profile-container" style="margin: 1.5rem 0 -0.25rem 0; position: relative;">
        <button class="btn-primary" onclick="saveProfile()" style="width: 100%;">Save Profile</button>
      </div>
    </div>
  </main>

  <footer>
    <div class="container">
      <p>&copy; 2025 Path Pal. v1.09.2</p>
    </div>
  </footer>

  <script src="/js/api.js"></script>
  <script src="/js/app.js"></script>
  <style>
    .major-option {
      position: relative;
      padding: 0.5rem 0.75rem;
      border: 2px solid var(--border-color);
      border-radius: 8px;
      background: var(--white);
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
      font-family: 'Arvo', serif;
      font-size: 0.85rem;
      color: var(--text-dark);
      -webkit-tap-highlight-color: transparent;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 40px;
    }
    .major-option:hover {
      border-color: var(--primary-green);
      background: var(--light-mint);
    }
    .major-option input[type="checkbox"] {
      position: absolute;
      opacity: 0;
      pointer-events: none;
    }
    .major-option.selected {
      background: var(--primary-green);
      color: var(--white);
      border-color: var(--primary-green);
    }
    .major-option.disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
  </style>
  <script>
    // Initialize user ID on page load
    document.addEventListener('DOMContentLoaded', async () => {
      // Initialize user ID first
      await initializeUserId();
      
      // Initialize majors selection
      initializeMajorsSelection();
      
      // Initialize profile picture upload
      const profilePictureInput = document.getElementById('profile-picture-input');
      if (profilePictureInput) {
        profilePictureInput.addEventListener('change', handleProfilePictureUpload);
      }
      
      // Load profile data
      loadProfile();
    });

    async function handleProfilePictureUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      // Validate file type
      if (!file.type.startsWith('image/')) {
        showNotification('Please select an image file', 'error');
        return;
      }

      // Validate file size (max 5MB)
      if (file.size > 5 * 1024 * 1024) {
        showNotification('Image must be smaller than 5MB', 'error');
        return;
      }

      const reader = new FileReader();
      reader.onload = async function(e) {
        const imageData = e.target.result;
        
        // Store in localStorage for immediate display
        localStorage.setItem('profile-picture', imageData);
        
        // Display the image
        const profilePicture = document.getElementById('profile-picture');
        const placeholder = document.getElementById('profile-picture-placeholder');
        if (profilePicture && placeholder) {
          profilePicture.src = imageData;
          profilePicture.style.display = 'block';
          placeholder.style.display = 'none';
        }
        
        // Save to server
        try {
          const userId = getUserId();
          const response = await fetch('/api/profile/picture', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              user_id: userId,
              profile_picture_base64: imageData
            })
          });

          const result = await response.json();
          if (result.success) {
            showNotification('Profile picture updated', 'success');
          } else {
            showNotification('Failed to save profile picture to server', 'error');
          }
        } catch (error) {
          console.error('Error saving profile picture:', error);
          showNotification('Profile picture saved locally, but failed to sync to server', 'warning');
        }
      };
      reader.readAsDataURL(file);
    }

    const MAJORS_LIST = [
      'Computer Science',
      'Engineering',
      'Business',
      'Medicine/Pre-Med',
      'Law/Pre-Law',
      'Education',
      'Psychology',
      'Biology',
      'Chemistry',
      'Mathematics',
      'Physics',
      'Economics',
      'Social Sciences',
      'Political Science',
      'Journalism',
      'Art',
      'Music',
      'Other'
    ];

    function initializeMajorsSelection() {
      const container = document.getElementById('majors-container');
      if (!container) return;

      container.innerHTML = '';
      MAJORS_LIST.forEach(major => {
        const option = document.createElement('div');
        option.className = 'major-option';
        option.dataset.major = major;
        
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = `major-${major.replace(/[^a-zA-Z0-9]/g, '-')}`;
        checkbox.value = major;
        
        const label = document.createElement('label');
        label.htmlFor = checkbox.id;
        label.textContent = major;
        label.style.cursor = 'pointer';
        label.style.display = 'flex';
        label.style.width = '100%';
        label.style.alignItems = 'center';
        label.style.justifyContent = 'center';
        label.style.margin = '0';
        
        option.appendChild(checkbox);
        option.appendChild(label);
        
        // Handle click on the entire option div
        option.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          
          const isSelected = checkbox.checked;
          const selectedCount = getSelectedMajors().length;
          
          if (isSelected) {
            // Deselect
            checkbox.checked = false;
            option.classList.remove('selected');
          } else {
            // Check if we can select (max 3)
            if (selectedCount >= 3) {
              showNotification('You can only select up to 3 majors.', 'warning');
              return;
            }
            checkbox.checked = true;
            option.classList.add('selected');
          }
          
          updateSelectedMajors();
        });
        
        container.appendChild(option);
      });
    }

    function getSelectedMajors() {
      const checkboxes = document.querySelectorAll('#majors-container input[type="checkbox"]:checked');
      return Array.from(checkboxes).map(cb => cb.value);
    }

    function showTestSection(type) {
      const sections = ['sat', 'psat', 'act'];
      sections.forEach(t => {
        const el = document.getElementById(`${t}-fields`);
        if (el) {
          el.style.display = (t.toUpperCase() === type) ? 'block' : 'none';
        }
      });
    }

    function clampScore(id, min, max) {
      const el = document.getElementById(id);
      if (!el) return null;
      let val = parseInt(el.value, 10);
      if (isNaN(val)) {
        el.value = '';
        return null;
      }
      if (val < min) val = min;
      if (val > max) val = max;
      el.value = val;
      return val;
    }

    function parseScore(id) {
      const el = document.getElementById(id);
      if (!el) return null;
      const val = parseInt(el.value, 10);
      return isNaN(val) ? null : val;
    }

    function updateSatTotal() {
      const r = parseScore('sat-reading');
      const m = parseScore('sat-math');
      const totalEl = document.getElementById('sat-total');
      if (!totalEl) return;
      if (r == null && m == null) {
        totalEl.textContent = '—';
        return;
      }
      const total = (r || 0) + (m || 0);
      totalEl.textContent = total || '—';
    }

    function updatePsatTotal() {
      const r = parseScore('psat-reading');
      const m = parseScore('psat-math');
      const totalEl = document.getElementById('psat-total');
      if (!totalEl) return;
      if (r == null && m == null) {
        totalEl.textContent = '—';
        return;
      }
      const total = (r || 0) + (m || 0);
      totalEl.textContent = total || '—';
    }

    function updateActComposite() {
      const scores = [
        parseScore('act-english'),
        parseScore('act-math'),
        parseScore('act-reading'),
        parseScore('act-science')
      ].filter(v => v != null);

      const compEl = document.getElementById('act-composite');
      if (!compEl) return;

      if (scores.length === 0) {
        compEl.textContent = '—';
        return;
      }

      const sum = scores.reduce((a, b) => a + b, 0);
      const avg = sum / scores.length;
      compEl.textContent = Math.round(avg);
    }

    function renderActivitiesRows(count, existing = []) {
      const container = document.getElementById('activities-table');
      if (!container) return;

      const n = Math.max(0, Math.min(10, parseInt(count, 10) || 0));
      let html = '';

      if (n > 0) {
        // Header row shown once at the top
        html += '<div class="form-row" style="display: flex; justify-content: flex-start; align-items: center; margin-bottom: 0.25rem; font-size: 0.8rem; color: var(--text-dark); font-weight: 600;">';
        html += '<div style="flex: 0 0 80px; max-width: 80px; margin-right: 0.25rem; text-align: center; white-space: nowrap;">Frequency</div>';
        html += '<div style="flex: 1; margin-left: 0.25rem; text-align: center;">Activity</div>';
        html += '</div>';
      }

      for (let i = 0; i < n; i++) {
        const row = existing[i] || {};
        // hours field now stores frequency value directly
        const frequency = row.hours || '';
        const desc = row.description || '';

        html += '<div class="form-row" style="margin-bottom: 0.05rem; display: flex; align-items: center; justify-content: flex-start;">';

        // Frequency dropdown (left)
        html += '<div class="form-group" style="flex: 0 0 80px; max-width: 80px; margin-right: 0.25rem;">';
        html += `<select id="activity-hours-${i}" style="width: 100%; font-size: 0.75rem;">`;
        html += '<option value="">...</option>';
        html += '<option value="daily" ' + (frequency === 'daily' ? 'selected' : '') + '>Daily</option>';
        html += '<option value="several-times-week" ' + (frequency === 'several-times-week' ? 'selected' : '') + '>Several/wk</option>';
        html += '<option value="weekly" ' + (frequency === 'weekly' ? 'selected' : '') + '>Weekly</option>';
        html += '<option value="monthly" ' + (frequency === 'monthly' ? 'selected' : '') + '>Monthly</option>';
        html += '<option value="rarely" ' + (frequency === 'rarely' ? 'selected' : '') + '>Rarely</option>';
        html += '</select>';
        html += '</div>';

        // Activity description (right - wide)
        html += '<div class="form-group" style="flex: 1; margin-left: 0.25rem;">';
        html += `<input type="text" id="activity-desc-${i}" maxlength="160" style="width: 100%;" placeholder="Activity ${i + 1} description" value="${desc}">`;
        html += '</div>';

        html += '</div>';
      }

      container.innerHTML = html;
    }

    function getApCourseOptions() {
      return [
      'AP Art History',
      'AP Biology',
      'AP Calculus AB',
      'AP Calculus BC',
      'AP Chemistry',
      'AP Chinese Language & Culture',
      'AP Comparative Government & Politics',
      'AP Computer Science A',
      'AP Computer Science Principles',
      'AP English Language & Composition',
      'AP English Literature & Composition',
      'AP Environmental Science',
      'AP European History',
      'AP French Language & Culture',
      'AP German Language & Culture',
      'AP Human Geography',
      'AP Italian Language & Culture',
      'AP Japanese Language & Culture',
      'AP Latin',
      'AP Macroeconomics',
      'AP Microeconomics',
      'AP Music Theory',
      'AP Physics 1',
      'AP Physics 2',
      'AP Physics C: Electricity & Magnetism',
      'AP Physics C: Mechanics',
      'AP Precalculus',
      'AP Psychology',
      'AP Research',
      'AP Seminar',
      'AP Spanish Language & Culture',
      'AP Spanish Literature & Culture',
      'AP Statistics',
      'AP Studio Art: 2-D Design',
      'AP Studio Art: 3-D Design',
      'AP Studio Art: Drawing',
      'AP US Government & Politics',
      'AP US History',
      'AP World History: Modern',
      'Other AP'
    ];

    }

    function renderApRows(count, existing = []) {
      const container = document.getElementById('ap-table');
      if (!container) return;

      const n = Math.max(0, Math.min(9, parseInt(count, 10) || 0));
      const options = getApCourseOptions();

      let html = '';
      for (let i = 0; i < n; i++) {
        const existingRow = existing[i] || {};
        const selectedCourse = existingRow.course || '';
        const selectedScore = existingRow.score || '';

        html += '<div class="form-row" style="margin-bottom: 0.5rem;">';
        // Course select
        html += '<div class="form-group" style="flex: 2; margin-right: 0.5rem;">';
        html += `<label style="font-size: 0.8rem; display:block; text-align:center;">AP Course ${i + 1}</label>`;
        html += `<select id="ap-course-${i}" style="width: 100%;">`;
        html += '<option value="">Select course</option>';
        options.forEach(opt => {
          const sel = opt === selectedCourse ? ' selected' : '';
          html += `<option value="${opt}"${sel}>${opt}</option>`;
        });
        html += '</select></div>';

        // Score select
        html += '<div class="form-group" style="flex: 1; margin-left: 0.5rem;">';
        html += `<label style="font-size: 0.8rem; display:block; text-align:center;">Score</label>`;
        html += `<select id="ap-score-${i}" style="width: 100%;">`;
        html += '<option value="">–</option>';
        for (let s = 1; s <= 5; s++) {
          const sel = String(s) === String(selectedScore) ? ' selected' : '';
          html += `<option value="${s}"${sel}>${s}</option>`;
        }
        html += '</select></div>';

        html += '</div>';
      }

      container.innerHTML = html;
    }

    async function loadProfile() {
      try {
        const profile = await UserProfile.get();
        
        // Load profile picture
        const profilePicture = document.getElementById('profile-picture');
        const placeholder = document.getElementById('profile-picture-placeholder');
        
        // Try to load from server first, then fallback to localStorage
        let savedPicture = localStorage.getItem('profile-picture');
        
        try {
          const userId = getUserId();
          const response = await fetch(`/api/profile/picture?user_id=${encodeURIComponent(userId)}`);
          if (response.ok) {
            const data = await response.json();
            if (data.success && data.profile_picture) {
              savedPicture = data.profile_picture;
              // Update localStorage with server version
              localStorage.setItem('profile-picture', savedPicture);
            }
          }
        } catch (error) {
          console.error('Error loading profile picture from server:', error);
        }
        
        if (savedPicture && profilePicture && placeholder) {
          profilePicture.src = savedPicture;
          profilePicture.style.display = 'block';
          placeholder.style.display = 'none';
        } else if (profilePicture && placeholder) {
          profilePicture.style.display = 'none';
          placeholder.style.display = 'block';
        }
        
        document.getElementById('name').value = profile.name || '';
        document.getElementById('grade').value = profile.grade || '';
        document.getElementById('gpa').value = profile.gpa || '';
        document.getElementById('weighted').checked = profile.weighted !== false;
        document.getElementById('career-goals').value = profile.careerGoals || '';
        
        // Initialize test section - load saved test type or default based on scores
        const testTypeSelect = document.getElementById('test-type');
        let initialType = '';
        if (testTypeSelect) {
          // First check if test type is saved in profile or localStorage
          const savedTestType = profile.testType || localStorage.getItem('test-type');
          if (savedTestType) {
            initialType = savedTestType;
          } else {
            // Fallback: determine from existing scores
            if (profile.sat) initialType = 'SAT';
            else if (profile.act) initialType = 'ACT';
            else if (profile.psat) initialType = 'PSAT';
          }

          testTypeSelect.value = initialType;
          showTestSection(initialType);
        }

        // Load individual test scores (from profile or localStorage)
        const savedTestScores = localStorage.getItem('test-scores');
        let testScores = {};
        if (savedTestScores) {
          try {
            testScores = JSON.parse(savedTestScores);
          } catch (e) {
            testScores = {};
          }
        }
        
        // Use profile values if available, otherwise use localStorage
        if (document.getElementById('sat-reading')) {
          document.getElementById('sat-reading').value = profile.satReading || testScores.satReading || '';
        }
        if (document.getElementById('sat-math')) {
          document.getElementById('sat-math').value = profile.satMath || testScores.satMath || '';
        }
        if (document.getElementById('psat-reading')) {
          document.getElementById('psat-reading').value = profile.psatReading || testScores.psatReading || '';
        }
        if (document.getElementById('psat-math')) {
          document.getElementById('psat-math').value = profile.psatMath || testScores.psatMath || '';
        }
        if (document.getElementById('act-english')) {
          document.getElementById('act-english').value = profile.actEnglish || testScores.actEnglish || '';
        }
        if (document.getElementById('act-math')) {
          document.getElementById('act-math').value = profile.actMath || testScores.actMath || '';
        }
        if (document.getElementById('act-reading')) {
          document.getElementById('act-reading').value = profile.actReading || testScores.actReading || '';
        }
        if (document.getElementById('act-science')) {
          document.getElementById('act-science').value = profile.actScience || testScores.actScience || '';
        }

        // Update totals after loading individual scores
        if (initialType === 'SAT') {
          updateSatTotal();
        } else if (initialType === 'PSAT') {
          updatePsatTotal();
        } else if (initialType === 'ACT') {
          updateActComposite();
        }

        // If we have total scores from an earlier version (but no individual scores), show them in the summary fields
        if (profile.sat && document.getElementById('sat-total') && !profile.satReading && !profile.satMath) {
          document.getElementById('sat-total').textContent = profile.sat;
        }
        if (profile.psat && document.getElementById('psat-total') && !profile.psatReading && !profile.psatMath) {
          document.getElementById('psat-total').textContent = profile.psat;
        }
        if (profile.act && document.getElementById('act-composite') && !profile.actEnglish && !profile.actMath) {
          document.getElementById('act-composite').textContent = profile.act;
        }

        // Initialize AP courses
        const apCountSelect = document.getElementById('ap-count');
        const apCourses = profile.apCourses || [];
        if (apCountSelect) {
          apCountSelect.value = Math.min(apCourses.length || 0, 9);
          renderApRows(apCountSelect.value, apCourses);
        }

        // Initialize activities - handle both JSON array and legacy string format
        const activitiesCountSelectInit = document.getElementById('activities-count');
        let activities = [];
        
        // Helper function to convert legacy hours to frequency (or keep frequency if already a frequency value)
        const normalizeFrequency = (hours) => {
          if (!hours) return '';
          // If it's already a frequency value, return it
          if (['daily', 'several-times-week', 'weekly', 'monthly', 'rarely'].includes(hours)) {
            return hours;
          }
          // Convert numeric hours to frequency
          const hrs = parseInt(hours) || 0;
          if (hrs >= 500) return 'daily';
          if (hrs >= 200) return 'several-times-week';
          if (hrs >= 50) return 'weekly';
          if (hrs >= 10) return 'monthly';
          return 'rarely';
        };
        
        if (profile.activities) {
          // If it's already an array, use it directly
          if (Array.isArray(profile.activities)) {
            activities = profile.activities.map(act => ({
              hours: normalizeFrequency(act.hours),
              description: act.description || ''
            }));
          } 
          // If it's a string, try to parse as JSON first
          else if (typeof profile.activities === 'string') {
            try {
              const parsed = JSON.parse(profile.activities);
              if (Array.isArray(parsed)) {
                activities = parsed.map(act => ({
                  hours: normalizeFrequency(act.hours),
                  description: act.description || ''
                }));
              } else {
                // Legacy string format: "X hrs — description" per line
                const lines = profile.activities.split('\n').map(l => l.trim()).filter(Boolean);
                activities = lines.slice(0, 10).map(line => {
                  const match = line.match(/^(\d+)\s*(hrs?|hours?|h)?\s*[-–:]\s*(.+)$/i);
                  if (match) {
                    return { hours: normalizeFrequency(match[1]), description: match[3] };
                  }
                  return { hours: '', description: line };
                });
              }
            } catch (e) {
              // Not valid JSON, treat as legacy string format
              const lines = profile.activities.split('\n').map(l => l.trim()).filter(Boolean);
              activities = lines.slice(0, 10).map(line => {
                const match = line.match(/^(\d+)\s*(hrs?|hours?|h)?\s*[-–:]\s*(.+)$/i);
                if (match) {
                  return { hours: normalizeFrequency(match[1]), description: match[3] };
                }
                return { hours: '', description: line };
              });
            }
          }
        }
        
        if (activitiesCountSelectInit) {
          activitiesCountSelectInit.value = activities.length;
          renderActivitiesRows(activities.length, activities);
        }
        
        // Load selected majors (respect max 3)
        if (profile.majors && profile.majors.length > 0) {
          const limitedMajors = profile.majors.slice(0, 3);
          limitedMajors.forEach(major => {
            const checkbox = document.querySelector(`#majors-container input[value="${major}"]`);
            if (checkbox) {
              checkbox.checked = true;
              const option = checkbox.closest('.major-option');
              if (option) {
                option.classList.add('selected');
              }
            }
          });
        }
        
        updateProfileName();
        updateSelectedMajors();
        document.getElementById('name').addEventListener('input', updateProfileName);
        document.getElementById('grade').addEventListener('change', updateProfileName);

        // AP count change
        const apCountSelectChange = document.getElementById('ap-count');
        if (apCountSelectChange) {
          apCountSelectChange.addEventListener('change', (e) => {
            const newCount = parseInt(e.target.value, 10) || 0;
            // Collect current AP course values before re-rendering
            // Check for existing AP inputs (up to 9)
            const currentApCourses = [];
            for (let i = 0; i < 9; i++) {
              const courseEl = document.getElementById(`ap-course-${i}`);
              const scoreEl = document.getElementById(`ap-score-${i}`);
              if (courseEl || scoreEl) {
                // Element exists, get its value
                const course = courseEl ? (courseEl.value || '').trim() : '';
                const score = scoreEl ? (scoreEl.value || '').trim() : '';
                currentApCourses.push({ course: course, score: score });
              } else {
                // Element doesn't exist yet, add empty entry
                currentApCourses.push({ course: '', score: '' });
              }
            }
            // Render with preserved values (will only show up to newCount)
            renderApRows(newCount, currentApCourses);
          });
        }

        // Activities count change
        const activitiesCountSelect = document.getElementById('activities-count');
        if (activitiesCountSelect) {
          activitiesCountSelect.addEventListener('change', (e) => {
            const newCount = parseInt(e.target.value, 10) || 0;
            // Collect current activity values before re-rendering
            // Check for existing activity inputs (up to 10)
            const currentActivities = [];
            for (let i = 0; i < 10; i++) {
              const frequencyEl = document.getElementById(`activity-hours-${i}`);
              const descEl = document.getElementById(`activity-desc-${i}`);
              if (frequencyEl || descEl) {
                // Element exists, get its value (frequency is stored directly)
                const frequency = frequencyEl ? frequencyEl.value : '';
                const desc = descEl ? (descEl.value || '').trim() : '';
                // Store frequency value directly in hours field
                currentActivities.push({ hours: frequency, description: desc });
              } else {
                // Element doesn't exist yet, add empty entry
                currentActivities.push({ hours: '', description: '' });
              }
            }
            // Render with preserved values (will only show up to newCount)
            renderActivitiesRows(newCount, currentActivities);
          });
        }

        // Test field listeners
        const testType = document.getElementById('test-type');
        if (testType) {
          testType.addEventListener('change', (e) => {
            const type = e.target.value || '';
            showTestSection(type);
          });
        }

        ['sat-reading', 'sat-math'].forEach(id => {
          const el = document.getElementById(id);
          if (el) {
            // While typing, allow 1–800 but cap anything above 800
            el.addEventListener('input', () => {
              const val = parseInt(el.value, 10);
              if (!isNaN(val) && val > 800) {
                el.value = 800;
              }
              updateSatTotal();
            });
            // On blur, round anything below 200 up to 200 (and still cap at 800)
            el.addEventListener('blur', () => {
              const val = parseInt(el.value, 10);
              if (isNaN(val)) {
                el.value = '';
              } else {
                if (val < 200) el.value = 200;
                if (val > 800) el.value = 800;
              }
              updateSatTotal();
            });
          }
        });
        ['psat-reading', 'psat-math'].forEach(id => {
          const el = document.getElementById(id);
          if (el) el.addEventListener('input', () => {
            clampScore(id, 160, 760);
            updatePsatTotal();
          });
        });
        ['act-english', 'act-math', 'act-reading', 'act-science'].forEach(id => {
          const el = document.getElementById(id);
          if (el) el.addEventListener('input', () => {
            clampScore(id, 1, 36);
            updateActComposite();
          });
        });
      } catch (error) {
        console.error('Error loading profile:', error);
        showNotification('Error loading profile. Using default values.', 'warning');
      }
    }

    function updateProfileName() {
      const name = document.getElementById('name').value || 'Student Name';
      const gradeValue = document.getElementById('grade').value || '';
      const gradeDisplay = gradeValue ? ` (${gradeValue})` : '';
      document.getElementById('profile-name').textContent = name + gradeDisplay;
    }

    function updateSelectedMajors() {
      const selected = getSelectedMajors();
      const container = document.getElementById('selected-majors');
      
      // Update disabled state for unselected options
      const allOptions = document.querySelectorAll('#majors-container .major-option');
      allOptions.forEach(option => {
        const checkbox = option.querySelector('input[type="checkbox"]');
        if (!checkbox.checked && selected.length >= 3) {
          option.classList.add('disabled');
        } else {
          option.classList.remove('disabled');
        }
      });
      
      if (selected.length > 0) {
        container.innerHTML = '<strong>Selected:</strong> ' + selected.join(', ');
      } else {
        container.innerHTML = '';
      }
    }

    async function saveProfile() {
      try {
        // Compute test totals based on current selection
        const testType = document.getElementById('test-type') ? document.getElementById('test-type').value : '';
        // Save test type to localStorage
        if (testType) {
          localStorage.setItem('test-type', testType);
        }
        let satTotal = '';
        let actComposite = '';
        let psatTotal = '';

        if (testType === 'SAT') {
          const r = parseScore('sat-reading');
          const m = parseScore('sat-math');
          if (r != null || m != null) {
            satTotal = (r || 0) + (m || 0);
          }
        } else if (testType === 'PSAT') {
          const r = parseScore('psat-reading');
          const m = parseScore('psat-math');
          if (r != null || m != null) {
            psatTotal = (r || 0) + (m || 0);
          }
        } else if (testType === 'ACT') {
          const scores = [
            parseScore('act-english'),
            parseScore('act-math'),
            parseScore('act-reading'),
            parseScore('act-science')
          ].filter(v => v != null);
          if (scores.length > 0) {
            const sum = scores.reduce((a, b) => a + b, 0);
            const avg = sum / scores.length;
            actComposite = Math.round(avg);
          }
        }

        // Collect AP courses
        const apCourses = [];
        const apCountVal = document.getElementById('ap-count') ? parseInt(document.getElementById('ap-count').value, 10) || 0 : 0;
        for (let i = 0; i < apCountVal && i < 9; i++) {
          const courseEl = document.getElementById(`ap-course-${i}`);
          const scoreEl = document.getElementById(`ap-score-${i}`);
          const course = courseEl ? courseEl.value : '';
          const score = scoreEl ? scoreEl.value : '';
          if (course) {
            apCourses.push({ course, score });
          }
        }

        // Collect activities as JSON array
        const activitiesArr = [];
        const activitiesCountVal = document.getElementById('activities-count') ? parseInt(document.getElementById('activities-count').value, 10) || 0 : 0;
        for (let i = 0; i < activitiesCountVal && i < 10; i++) {
          const frequencyEl = document.getElementById(`activity-hours-${i}`);
          const descEl = document.getElementById(`activity-desc-${i}`);
          const frequency = frequencyEl ? frequencyEl.value : '';
          const desc = descEl ? (descEl.value || '').trim() : '';
          if (desc) {
            // Store frequency value directly (not converting to hours)
            activitiesArr.push({ hours: frequency, description: desc });
          }
        }

        // Get individual test scores for saving
        const satReading = testType === 'SAT' ? (parseScore('sat-reading') || '') : '';
        const satMath = testType === 'SAT' ? (parseScore('sat-math') || '') : '';
        const psatReading = testType === 'PSAT' ? (parseScore('psat-reading') || '') : '';
        const psatMath = testType === 'PSAT' ? (parseScore('psat-math') || '') : '';
        const actEnglish = testType === 'ACT' ? (parseScore('act-english') || '') : '';
        const actMath = testType === 'ACT' ? (parseScore('act-math') || '') : '';
        const actReading = testType === 'ACT' ? (parseScore('act-reading') || '') : '';
        const actScience = testType === 'ACT' ? (parseScore('act-science') || '') : '';

        // Save individual test scores to localStorage
        const testScores = {
          satReading: satReading,
          satMath: satMath,
          psatReading: psatReading,
          psatMath: psatMath,
          actEnglish: actEnglish,
          actMath: actMath,
          actReading: actReading,
          actScience: actScience
        };
        localStorage.setItem('test-scores', JSON.stringify(testScores));

        const profile = {
          name: document.getElementById('name').value,
          grade: document.getElementById('grade').value,
          gpa: document.getElementById('gpa').value,
          weighted: document.getElementById('weighted').checked,
          testType: testType, // Save the test type selection
          sat: satTotal || '',
          act: actComposite || '',
          psat: psatTotal || '',
          satReading: satReading,
          satMath: satMath,
          psatReading: psatReading,
          psatMath: psatMath,
          actEnglish: actEnglish,
          actMath: actMath,
          actReading: actReading,
          actScience: actScience,
          majors: getSelectedMajors(),
          apCourses: apCourses,
          activities: activitiesArr, // Store as JSON array
          careerGoals: document.getElementById('career-goals').value
        };
        
        await UserProfile.save(profile);
        showNotification('Profile saved successfully!', 'success');
        
        // Update profile name display
        updateProfileName();
      } catch (error) {
        console.error('Error saving profile:', error);
        showNotification('Error saving profile. Please try again.', 'error');
      }
    }
  </script>
  <script src="/js/auth.js"></script>
  <script>
    function handleSignOut() {
      signOut();
      window.location.href = '/pages/login.html';
    }

    // Auto-save profile when navigating to different tabs
    document.addEventListener('DOMContentLoaded', () => {
      // Intercept all navigation link clicks
      const navLinks = document.querySelectorAll('nav a[href^="/"]');
      navLinks.forEach(link => {
        // Skip the current page (profile.html), sign out, and external links
        const href = link.getAttribute('href');
        if (href.includes('/profile.html') || link.onclick || href.startsWith('http')) {
          return;
        }
        
        link.addEventListener('click', async (e) => {
          e.preventDefault();
          const targetUrl = href;
          
          // Save profile before navigating
          try {
            await saveProfile();
          } catch (error) {
            console.error('Error auto-saving profile:', error);
          }
          
          // Navigate after save completes
          window.location.href = targetUrl;
        });
      });

      // Also save on visibility change (when tab becomes hidden)
      document.addEventListener('visibilitychange', async () => {
        if (document.hidden) {
          try {
            await saveProfile();
          } catch (error) {
            console.error('Error auto-saving profile on visibility change:', error);
          }
        }
      });
    });
  </script>
</body>
</html>

