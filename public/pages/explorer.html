<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="College Explorer - Path Pal">
  <title>College Explorer - Path Pal</title>
  <link rel="manifest" href="/manifest.json">
  <link rel="stylesheet" href="/css/style.css">
  <meta name="theme-color" content="#0d8c79">
  <style>
    .search-container {
      margin-bottom: 0.75rem;
    }
    .search-container input {
      width: 100%;
      padding: 0.75rem;
      border: 2px solid var(--border-color);
      border-radius: 8px;
      font-size: 1rem;
      font-family: 'Arvo', serif;
    }
    .search-container input:focus {
      outline: none;
      border-color: var(--primary-green);
    }
    .filters {
      background: var(--white);
      padding: 1.5rem;
      border-radius: 12px;
      margin-bottom: 1.5rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .filters-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 1rem;
      margin-bottom: 0.5rem;
    }
    .college-card {
      background: var(--white);
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .college-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .college-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 1rem;
      flex-wrap: wrap;
      gap: 0.5rem;
    }
    .college-name {
      color: var(--primary-green);
      font-size: 1.25rem;
      font-weight: bold;
      margin: 0 0 0.5rem 0;
    }
    .college-info {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 0.75rem;
      margin-bottom: 1rem;
      font-size: 0.9rem;
      color: var(--text-light);
    }
    .college-info-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .college-info-item img {
      width: 16px;
      height: 16px;
      opacity: 0.7;
    }
    .stats-box-container {
      display: flex;
      gap: 0.75rem;
      margin-bottom: 0.5rem;
    }
    .odds-display, .acceptance-display {
      flex: 1;
      background: linear-gradient(135deg, var(--primary-green), rgba(13, 140, 121, 0.95));
      padding: 0.75rem 1rem;
      border-radius: 8px;
      text-align: center;
      color: var(--white);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      position: relative;
    }
    .odds-display.reach {
      background: linear-gradient(135deg, #ffe5e5, #ffcccc);
      color: #c0392b;
    }
    .odds-display.target {
      background: linear-gradient(135deg, #ffd54f, #ffb300);
      color: #e65100;
    }
    .odds-display.safety {
      background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
      color: #27ae60;
    }
    .acceptance-display {
      background: linear-gradient(135deg, rgba(13, 140, 121, 0.95), var(--primary-green));
    }
    .odds-number-container {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }
    .odds-badge {
      font-size: 0.7rem;
      font-weight: bold;
      opacity: 0.9;
    }
    .odds-display .odds-number,
    .acceptance-display .acceptance-number {
      font-size: 1.5rem;
      font-weight: bold;
      margin: 0;
      line-height: 1.2;
    }
    .odds-display .odds-label,
    .acceptance-display .acceptance-label {
      font-size: 0.7rem;
      opacity: 0.9;
      margin-top: 0.25rem;
    }
    .collapse-toggle {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0.25rem;
      margin: 0.5rem 0;
      cursor: pointer;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      background: var(--light-mint);
      transition: background 0.2s;
    }
    .collapse-toggle:hover {
      background: var(--primary-green);
      color: var(--white);
    }
    .collapse-toggle .caret {
      font-size: 0.5rem;
      font-weight: 100;
      transition: transform 0.3s;
      line-height: 1;
      letter-spacing: -0.05em;
    }
    .collapse-toggle.expanded .caret {
      transform: rotate(180deg);
    }
    .collapsible-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease-out;
    }
    .collapsible-content.expanded {
      max-height: 2000px;
      transition: max-height 0.5s ease-in;
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 0.5rem;
      margin-bottom: 0.75rem;
      font-size: 0.85rem;
    }
    .stat-item {
      padding: 0.5rem;
      background: var(--light-mint);
      border-radius: 6px;
      text-align: center;
    }
    .stat-value {
      font-weight: bold;
      color: var(--primary-green);
      font-size: 0.9rem;
      margin-bottom: 0.25rem;
    }
    .stat-label {
      font-size: 0.75rem;
      color: var(--text-light);
    }
    .info-section {
      margin-top: 0.75rem;
      padding-top: 0.75rem;
      border-top: 1px solid var(--border-color);
      font-size: 0.8rem;
    }
    .info-row {
      display: flex;
      justify-content: space-between;
      padding: 0.25rem 0;
      border-bottom: 1px solid rgba(0,0,0,0.05);
    }
    .info-row:last-child {
      border-bottom: none;
    }
    .info-label {
      font-weight: 600;
      color: var(--text-dark);
      flex: 0 0 40%;
    }
    .info-value {
      color: var(--text-light);
      text-align: right;
      flex: 1;
    }
    .college-actions {
      display: flex;
      gap: 0.75rem;
    }
    .college-actions button {
      flex: 1;
    }
    .loading {
      text-align: center;
      padding: 2rem;
      color: var(--text-light);
    }
    .no-results {
      text-align: center;
      padding: 2rem;
      color: var(--text-light);
    }
    .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 1rem;
      margin-top: 2rem;
      flex-wrap: wrap;
    }
    .pagination button {
      padding: 0.5rem 1rem;
      border: 2px solid var(--border-color);
      background: var(--white);
      border-radius: 8px;
      cursor: pointer;
      font-family: 'Arvo', serif;
    }
    .pagination button:hover:not(:disabled) {
      border-color: var(--primary-green);
      background: var(--light-mint);
    }
    .pagination button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .pagination-info {
      color: var(--text-light);
      font-size: 0.9rem;
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 0.75rem;
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid var(--border-color);
    }
    .stat-item {
      text-align: center;
    }
    .stat-value {
      font-size: 1.1rem;
      font-weight: bold;
      color: var(--primary-green);
    }
    .stat-label {
      font-size: 0.75rem;
      color: var(--text-light);
      margin-top: 0.25rem;
    }
  </style>
</head>
<body>
  <div class="desktop-message">
    <h1><img src="/media/icons/Mobile256x256.png" alt="Mobile" style="width: 48px; height: 48px; vertical-align: middle; margin-right: 0.5rem;"> Mobile App Required</h1>
    <p>Path Pal is designed for mobile devices. Please open this site on your mobile phone or tablet.</p>
  </div>

  <header>
    <div class="header-content container">
      <div class="logo">
        <a href="/index.html" style="display: flex; align-items: center; gap: 0.5rem; text-decoration: none; color: inherit;">
        <img src="/media/logo/logo64x64.png" alt="Path Pal Logo">
        <h1>Path Pal</h1>
        </a>
      </div>
      <button class="menu-toggle" aria-label="Toggle menu"><img src="/media/icons/Hamburger128x128.png" alt="Menu" style="width: 24px; height: 24px;"></button>
    </div>
  </header>

  <nav>
    <ul>
      <li><a href="/index.html"><img src="/media/icons/Home256x256.png" alt="Home" class="nav-icon"> Home</a></li>
      <li><a href="/profile.html"><img src="/media/icons/Profile256x256.png" alt="Profile" class="nav-icon"> My Profile</a></li>
      <li><a href="/odds.html"><img src="/media/icons/Odds256x256.png" alt="Admissions Odds" class="nav-icon"> Admissions Odds</a></li>
      <li><a href="/simulator.html"><img src="/media/icons/WhatIf256x256.png" alt="What If" class="nav-icon"> "What If" Simulator</a></li>
      <li><a href="/explorer.html" class="active"><img src="/media/icons/Search256x256.png" alt="College Explorer" class="nav-icon"> College Explorer</a></li>
      <li><a href="/career.html"><img src="/media/icons/DollarSign256x256.png" alt="Career & Salary Paths" class="nav-icon"> Career & Salary Paths</a></li>
      <li><a href="/activities.html"><img src="/media/icons/Activity256x256.png" alt="Activities" class="nav-icon"> Activity & Internship Recs</a></li>
      <li><a href="/planner.html"><img src="/media/icons/Calender256x256.png" alt="4-Year Planner" class="nav-icon"> 4-Year Planner</a></li>
      <li><a href="/messages.html"><img src="/media/icons/Chat256x256.png" alt="AI Counselor" class="nav-icon"> AI Counselor</a></li>
      <li><a href="/saved.html"><img src="/media/icons/Star256x256.png" alt="Saved Colleges" class="nav-icon"> Saved Colleges</a></li>
      <li><a href="#" onclick="handleSignOut(); return false;"><img src="/media/icons/SignOut256x256.png" alt="Sign Out" class="nav-icon"> Sign Out</a></li>
      <li><a href="https://forms.gle/ULMYUSDifpanJ9KMA" target="_blank"><img src="/media/icons/Feedback256x256.png" alt="Feedback" class="nav-icon"> Feedback</a></li>
    </ul>
  </nav>

  <main>
    <div class="container">
      <h2 style="color: var(--primary-green); margin: 1rem 0;">College Explorer</h2>

      <!-- Search -->
      <div class="search-container">
        <input type="text" id="search-input" placeholder="Search colleges by name, city, or state..." oninput="handleSearch()">
      </div>

      <!-- Filters -->
      <div class="filters">
        <h3 style="color: var(--primary-green); margin-bottom: 1rem;">Filters</h3>
        <div class="filters-grid">
          <div class="form-group">
            <label>Admission Odds</label>
            <select id="filter-chance">
              <option value="">All</option>
              <option value="safety">Safety (70%+)</option>
              <option value="target">Target (40-70%)</option>
              <option value="reach">Reach (&lt;40%)</option>
            </select>
          </div>
          <div class="form-group">
            <label>Region</label>
            <select id="filter-region">
              <option value="">All Regions</option>
              <option value="Northeast">Northeast</option>
              <option value="Southeast">Southeast</option>
              <option value="Midwest">Midwest</option>
              <option value="Southwest">Southwest</option>
              <option value="West">West</option>
            </select>
          </div>
          <div class="form-group">
            <label>School Size</label>
            <select id="filter-size">
              <option value="">All Sizes</option>
              <option value="Small">Small (&lt;5,000)</option>
              <option value="Medium">Medium (5,000-15,000)</option>
              <option value="Large">Large (&gt;15,000)</option>
            </select>
          </div>
          <div class="form-group">
            <label>School Type</label>
            <select id="filter-type">
              <option value="">All Types</option>
              <option value="Public">Public</option>
              <option value="Private">Private</option>
              <option value="Private For-Profit">Private For-Profit</option>
            </select>
          </div>
          <div class="form-group">
            <label>Test Optional</label>
            <select id="filter-test-optional">
              <option value="">All</option>
              <option value="true">Yes</option>
              <option value="false">No</option>
            </select>
          </div>
          <div class="form-group">
            <label>Tuition</label>
            <select id="filter-tuition">
              <option value="">All</option>
              <option value="15">Less than $15k</option>
              <option value="30">Less than $30k</option>
              <option value="45">Less than $45k</option>
              <option value="60">Less than $60k</option>
            </select>
          </div>
        </div>
        <button class="btn btn-primary" onclick="applyFilters()" style="width: 100%; margin-top: 0.5rem;">
          Apply Filters
        </button>
        <button class="btn btn-secondary" onclick="resetFilters()" style="width: 100%; margin-top: 0.5rem;">
          Reset Filters
        </button>
      </div>

      <!-- Sort By -->
      <div class="filters" style="margin-top: 1rem;">
        <div class="form-group">
          <label>Sort By</label>
          <select id="sort-by" onchange="applyFilters()">
            <option value="name">Name (A-Z)</option>
            <option value="acceptance-high">Acceptance Rate (High to Low)</option>
            <option value="acceptance-low">Acceptance Rate (Low to High)</option>
            <option value="enrollment-high">Number of Students (High to Low)</option>
            <option value="enrollment-low">Number of Students (Low to High)</option>
          </select>
        </div>
      </div>

      <!-- College List -->
      <div id="colleges-list">
        <div class="loading">Loading colleges...</div>
      </div>

      <!-- Pagination -->
      <div id="pagination" class="pagination" style="display: none;"></div>
    </div>
  </main>

  <footer>
    <div class="container">
      <p>&copy; Path Pal 2025 — v1.09.2</p>
    </div>
  </footer>

  <script src="/js/api.js"></script>
  <script src="/js/app.js"></script>
  <script>
    let allColleges = [];
    let filteredColleges = [];
    let currentPage = 1;
    const perPage = 20;
    let searchTimeout = null;
    let studentProfile = null;
    let studentRating = null;

    // Client-side implementation of getAdmissionOdds (from rate-system.js)
    function getAdmissionOdds(studentScore, collegeScore, acceptanceRate) {
      // Parse inputs
      const student = typeof studentScore === 'string' ? parseFloat(studentScore) : (studentScore || 0);
      const college = typeof collegeScore === 'string' ? parseFloat(collegeScore) : (collegeScore || 0);
      const acceptance = typeof acceptanceRate === 'string' ? parseFloat(acceptanceRate) : (acceptanceRate || null);

      // Ensure scores are in valid range
      const studentNorm = Math.max(0, Math.min(100, student));
      const collegeNorm = Math.max(0, Math.min(100, college));

      // Calculate delta (difference)
      const delta = studentNorm - collegeNorm;

      // Base odds when scores are equal - start from the college's acceptance rate if available
      // If no acceptance rate, default to 50%
      let baseOdds = 50;
      if (acceptance !== null && acceptance >= 0 && acceptance <= 1) {
        // Use acceptance rate as base, but adjust based on score delta
        // For example: 15% acceptance rate college = base odds of 15% when student matches college
        baseOdds = acceptance * 100;
      }

      // Calculate odds based on delta
      // Positive delta (student > college) = higher odds
      // Negative delta (student < college) = lower odds
      
      // Use a sigmoid-like curve for smooth transitions
      const deltaMultiplier = 1.5; // Each point of delta = 1.5% change
      let odds = baseOdds + (delta * deltaMultiplier);

      // Apply sigmoid-like curve for more realistic distribution
      // This makes extreme differences less impactful
      const sigmoidFactor = 0.8; // Smoothing factor
      const normalizedDelta = delta / 50; // Normalize to -1 to 1 range
      const sigmoidDelta = (normalizedDelta / (1 + Math.abs(normalizedDelta) * sigmoidFactor)) * 50;
      odds = baseOdds + (sigmoidDelta * deltaMultiplier);

      // If acceptance rate is provided, use it as a constraint
      // The odds should not exceed the acceptance rate by too much, and should scale with it
      if (acceptance !== null && acceptance >= 0 && acceptance <= 1) {
        const acceptancePercent = acceptance * 100;
        
        // Scale the odds relative to the acceptance rate
        // If baseOdds was set from acceptance rate, we've already accounted for it
        // But we should ensure odds don't go too far above/below the acceptance rate based on delta alone
        
        // For highly selective schools (low acceptance), limit how high odds can go
        if (acceptancePercent < 20) {
          // Very selective: odds can go up to 2.5x the acceptance rate for strong students
          const maxOdds = Math.min(acceptancePercent * 2.5, 95);
          odds = Math.min(odds, maxOdds);
        } else if (acceptancePercent < 50) {
          // Moderately selective: odds can go up to 1.8x the acceptance rate
          const maxOdds = Math.min(acceptancePercent * 1.8, 95);
          odds = Math.min(odds, maxOdds);
        } else {
          // Less selective: odds can go higher, but still cap at reasonable level
          const maxOdds = Math.min(acceptancePercent * 1.5, 95);
          odds = Math.min(odds, maxOdds);
        }
        
        // Ensure odds don't go below a minimum based on acceptance rate
        // Even weak students have some chance at less selective schools
        if (acceptancePercent > 50) {
          const minOdds = Math.max(acceptancePercent * 0.3, 5);
          odds = Math.max(odds, minOdds);
        } else {
          const minOdds = Math.max(acceptancePercent * 0.2, 2);
          odds = Math.max(odds, minOdds);
        }
      }

      // Clamp to reasonable bounds (2% to 98%)
      odds = Math.max(2, Math.min(98, odds));

      // Round to nearest integer
      return Math.round(odds);
    }

    function categorizeSchool(odds) {
      if (odds >= 70) return { category: 'safety', label: 'Safety' };
      if (odds >= 40) return { category: 'target', label: 'Target' };
      return { category: 'reach', label: 'Reach' };
    }

    function isProfileComplete(profile) {
      // Profile is complete if it has rating or has at least GPA or test scores
      if (profile.rating !== null && profile.rating !== undefined) {
        return true;
      }
      // Check if we have enough data to calculate a rating
      return !!(profile.gpa || profile.sat || profile.act);
    }

    document.addEventListener('DOMContentLoaded', async () => {
      await initializeUserId();
      // Load student profile to get rating
      // Rating only exists if profile was saved (100% complete)
      try {
        studentProfile = await UserProfile.get();
        // Only use rating if it exists (profile was saved and rated)
        studentRating = (studentProfile.rating !== null && studentProfile.rating !== undefined && studentProfile.rating !== '') 
          ? studentProfile.rating 
          : null;
      } catch (error) {
        console.error('Error loading profile:', error);
        studentRating = null;
      }
      await loadColleges();
    });

    async function loadColleges() {
      const container = document.getElementById('colleges-list');
      container.innerHTML = '<div class="loading">Loading colleges...</div>';

      try {
        const response = await fetch('/api/colleges?per_page=10000'); // Load all for filtering
        const data = await response.json();
        
        allColleges = data.results || [];
        filteredColleges = sortColleges([...allColleges]);
        
        displayColleges();
      } catch (error) {
        console.error('Error loading colleges:', error);
        container.innerHTML = '<div class="no-results">Error loading colleges. Please try again later.</div>';
      }
    }

    // Helper function for fuzzy string matching (Levenshtein distance)
    function levenshteinDistance(str1, str2) {
      const len1 = str1.length;
      const len2 = str2.length;
      const matrix = [];
      
      for (let i = 0; i <= len1; i++) {
        matrix[i] = [i];
      }
      
      for (let j = 0; j <= len2; j++) {
        matrix[0][j] = j;
      }
      
      for (let i = 1; i <= len1; i++) {
        for (let j = 1; j <= len2; j++) {
          if (str1[i - 1] === str2[j - 1]) {
            matrix[i][j] = matrix[i - 1][j - 1];
          } else {
            matrix[i][j] = Math.min(
              matrix[i - 1][j] + 1,     // deletion
              matrix[i][j - 1] + 1,     // insertion
              matrix[i - 1][j - 1] + 1  // substitution
            );
          }
        }
      }
      
      return matrix[len1][len2];
    }

    // Helper function to check if search term matches college (with abbreviations and fuzzy matching)
    function matchesSearch(college, searchTerm) {
      if (!searchTerm) return true;
      
      const name = (college.name || '').toLowerCase();
      
      // 1. Check if search term is a substring of the college name (e.g., "stan" matches "stanford")
      if (name.includes(searchTerm)) {
        return true;
      }
      
      // 2. Check if search term matches first letters of words in order (abbreviation matching)
      const skipWords = new Set(['of', 'the', 'and', 'at', 'in', 'on', 'for', 'a', 'an']);
      const nameWords = name.split(/\s+/);
      const significantWords = nameWords.filter(w => w.length > 0 && !skipWords.has(w));
      
      if (significantWords.length >= searchTerm.length) {
        let searchIndex = 0;
        for (let i = 0; i < significantWords.length && searchIndex < searchTerm.length; i++) {
          const firstLetter = significantWords[i][0];
          if (firstLetter === searchTerm[searchIndex]) {
            searchIndex++;
          }
        }
        // If all characters of search term matched first letters in order, it's a match
        if (searchIndex === searchTerm.length) {
          return true;
        }
      }
      
      // 3. Check if search term is within 2 character differences (fuzzy matching)
      const distance = levenshteinDistance(searchTerm, name);
      if (distance <= 2) {
        return true;
      }
      
      return false;
    }

    function handleSearch() {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => {
        applyFilters();
      }, 300);
    }

    function sortColleges(colleges) {
      const sortBy = document.getElementById('sort-by').value;
      
      return [...colleges].sort((a, b) => {
        switch (sortBy) {
          case 'name':
            // Sort alphabetically by name
            const nameA = (a.name || '').toLowerCase();
            const nameB = (b.name || '').toLowerCase();
            return nameA.localeCompare(nameB);
          
          case 'acceptance-high':
            // Sort by acceptance rate: high to low
            const rateA = a.acceptanceRate !== null && a.acceptanceRate !== undefined ? a.acceptanceRate : -1;
            const rateB = b.acceptanceRate !== null && b.acceptanceRate !== undefined ? b.acceptanceRate : -1;
            // Put null values at the end
            if (rateA === -1 && rateB === -1) return 0;
            if (rateA === -1) return 1;
            if (rateB === -1) return -1;
            return rateB - rateA; // High to low
          
          case 'acceptance-low':
            // Sort by acceptance rate: low to high
            const rateALow = a.acceptanceRate !== null && a.acceptanceRate !== undefined ? a.acceptanceRate : 999;
            const rateBLow = b.acceptanceRate !== null && b.acceptanceRate !== undefined ? b.acceptanceRate : 999;
            // Put null values at the end
            if (rateALow === 999 && rateBLow === 999) return 0;
            if (rateALow === 999) return 1;
            if (rateBLow === 999) return -1;
            return rateALow - rateBLow; // Low to high
          
          case 'enrollment-high':
            // Sort by enrollment: high to low
            const enrollA = a.enrollment !== null && a.enrollment !== undefined ? a.enrollment : -1;
            const enrollB = b.enrollment !== null && b.enrollment !== undefined ? b.enrollment : -1;
            // Put null values at the end
            if (enrollA === -1 && enrollB === -1) return 0;
            if (enrollA === -1) return 1;
            if (enrollB === -1) return -1;
            return enrollB - enrollA; // High to low
          
          case 'enrollment-low':
            // Sort by enrollment: low to high
            const enrollALow = a.enrollment !== null && a.enrollment !== undefined ? a.enrollment : 999999;
            const enrollBLow = b.enrollment !== null && b.enrollment !== undefined ? b.enrollment : 999999;
            // Put null values at the end
            if (enrollALow === 999999 && enrollBLow === 999999) return 0;
            if (enrollALow === 999999) return 1;
            if (enrollBLow === 999999) return -1;
            return enrollALow - enrollBLow; // Low to high
          
          default:
            return 0;
        }
      });
    }

    function applyFilters() {
      const searchTerm = document.getElementById('search-input').value.toLowerCase().trim();
      const chanceFilter = document.getElementById('filter-chance').value;
      const regionFilter = document.getElementById('filter-region').value;
      const sizeFilter = document.getElementById('filter-size').value;
      const typeFilter = document.getElementById('filter-type').value;
      const testOptionalFilter = document.getElementById('filter-test-optional').value;
      const tuitionFilter = document.getElementById('filter-tuition').value;

      filteredColleges = allColleges.filter(college => {
        // Search filter with abbreviations and fuzzy matching
        if (searchTerm) {
          if (!matchesSearch(college, searchTerm)) {
            return false;
          }
        }

        // Chance filter (using actual admission odds)
        if (chanceFilter) {
          // Skip filter if profile incomplete or college rating missing
          if (studentRating === null || studentRating === undefined || college.rating === null || college.rating === undefined) {
            return false; // Hide colleges when we can't calculate odds
          }
          const odds = getAdmissionOdds(studentRating, college.rating, college.acceptanceRate);
          const category = categorizeSchool(odds);
          if (category.category !== chanceFilter) return false;
        }

        // Region filter
        if (regionFilter && college.region !== regionFilter) return false;

        // Size filter
        if (sizeFilter && college.size !== sizeFilter) return false;

        // Type filter
        if (typeFilter && college.type !== typeFilter) return false;

        // Test Optional filter
        if (testOptionalFilter) {
          const isTestOptional = college.testOptional === true || college.testOptional === 'true' || college.testOptional === 1;
          const filterValue = testOptionalFilter === 'true';
          if (isTestOptional !== filterValue) return false;
        }

        // Tuition filter (based on out-of-state tuition)
        if (tuitionFilter) {
          const maxTuition = parseInt(tuitionFilter) * 1000; // Convert to dollars (15k = 15000)
          const outOfStateTuition = college.tuitionOutState;
          if (outOfStateTuition === null || outOfStateTuition === undefined || outOfStateTuition >= maxTuition) {
            return false;
          }
        }

        return true;
      });

      // Sort the filtered colleges
      filteredColleges = sortColleges(filteredColleges);

      currentPage = 1;
      displayColleges();
    }

    function resetFilters() {
      document.getElementById('search-input').value = '';
      document.getElementById('filter-chance').value = '';
      document.getElementById('filter-region').value = '';
      document.getElementById('filter-size').value = '';
      document.getElementById('filter-type').value = '';
      document.getElementById('filter-test-optional').value = '';
      document.getElementById('filter-tuition').value = '';
      document.getElementById('sort-by').value = 'name';
      filteredColleges = sortColleges([...allColleges]);
      currentPage = 1;
      displayColleges();
    }

    function displayColleges() {
      const container = document.getElementById('colleges-list');
      const paginationEl = document.getElementById('pagination');

      if (filteredColleges.length === 0) {
        container.innerHTML = '<div class="no-results">No colleges match your filters. Try adjusting your search criteria.</div>';
        paginationEl.style.display = 'none';
        return;
    }

      // Pagination
      const totalPages = Math.ceil(filteredColleges.length / perPage);
      const start = (currentPage - 1) * perPage;
      const end = start + perPage;
      const pageColleges = filteredColleges.slice(start, end);

      container.innerHTML = `<h3 style="color: var(--primary-green); margin: 1rem 0;">Found ${filteredColleges.length} College${filteredColleges.length !== 1 ? 's' : ''}</h3>`;

      pageColleges.forEach(college => {
        // Calculate admission odds
        let odds;
        let oddsDisplay;
        if (studentRating !== null && studentRating !== undefined && college.rating !== null && college.rating !== undefined) {
          odds = getAdmissionOdds(studentRating, college.rating, college.acceptanceRate);
          oddsDisplay = odds + '%';
        } else {
          odds = null;
          oddsDisplay = 'N/A';
        }
        const category = odds !== null ? categorizeSchool(odds) : { category: 'unknown', label: 'Unknown' };
        const isSaved = SavedColleges.isSaved(college.id);
        
        const card = document.createElement('div');
        card.className = 'college-card';
        
        // Format numbers
        const formatNumber = (num) => {
          if (num === null || num === undefined || num === '') return 'N/A';
          return num.toLocaleString();
        };
        
        const formatCurrency = (num) => {
          if (num === null || num === undefined || num === '') return 'N/A';
          return '$' + num.toLocaleString();
        };
        
        const formatPercent = (num) => {
          if (num === null || num === undefined || num === '') return 'N/A';
          return (num * 100).toFixed(1) + '%';
        };
        
        const formatPercentRounded = (num) => {
          if (num === null || num === undefined || num === '') return 'N/A';
          return Math.round(num * 100) + '%';
        };

        card.innerHTML = `
          <div class="college-header" style="margin-bottom: 0.5rem;">
            <div style="flex: 1;">
              <h4 class="college-name" style="margin-bottom: 0.25rem;">${college.name}</h4>
              <div style="display: flex; gap: 0.75rem; flex-wrap: wrap; align-items: center; font-size: 0.8rem; color: var(--text-light);">
                <span>${college.location || 'N/A'}</span>
                <span>•</span>
                <span>${college.type || 'N/A'}</span>
                <span>•</span>
                <span>${college.size || 'N/A'}</span>
                ${college.region ? `<span>•</span><span>${college.region}</span>` : ''}
              </div>
            </div>
          </div>
          
          <div class="stats-box-container">
            <div class="odds-display ${odds !== null ? category.category : ''}">
              <div class="odds-number-container">
                <div class="odds-number">${oddsDisplay}</div>
                ${odds !== null ? `<span class="odds-badge">${category.label}</span>` : ''}
              </div>
              <div class="odds-label">Your Admission Odds</div>
            </div>
            <div class="acceptance-display">
              <div class="acceptance-number">${college.acceptanceRate !== null ? formatPercentRounded(college.acceptanceRate) : 'N/A'}</div>
              <div class="acceptance-label">Acceptance Rate</div>
            </div>
          </div>

          <div class="collapse-toggle" onclick="toggleCollegeDetails('${college.id}')" id="toggle-${college.id}">
            <span class="caret">▼</span>
          </div>

          <div class="collapsible-content" id="content-${college.id}">
            <div class="info-section">
            ${college.satAverage !== null ? `
            <div class="info-row">
              <span class="info-label">Avg SAT</span>
              <span class="info-value">${formatNumber(college.satAverage)}</span>
            </div>
            ` : ''}
            ${college.actMidpoint !== null ? `
            <div class="info-row">
              <span class="info-label">Avg ACT</span>
              <span class="info-value">${formatNumber(college.actMidpoint)}</span>
            </div>
            ` : ''}
            ${college.tuitionInState !== null ? `
            <div class="info-row">
              <span class="info-label">In-State Tuition</span>
              <span class="info-value">${formatCurrency(college.tuitionInState)}</span>
            </div>
            ` : ''}
            ${college.tuitionOutState !== null ? `
            <div class="info-row">
              <span class="info-label">Out-of-State Tuition</span>
              <span class="info-value">${formatCurrency(college.tuitionOutState)}</span>
            </div>
            ` : ''}
            ${college.roomBoard !== null ? `
            <div class="info-row">
              <span class="info-label">Room & Board</span>
              <span class="info-value">${formatCurrency(college.roomBoard)}</span>
            </div>
            ` : ''}
            ${college.graduationRate !== null ? `
            <div class="info-row">
              <span class="info-label">Graduation Rate</span>
              <span class="info-value">${formatPercent(college.graduationRate)}</span>
            </div>
            ` : ''}
            ${college.retentionRate !== null ? `
            <div class="info-row">
              <span class="info-label">Retention Rate</span>
              <span class="info-value">${formatPercent(college.retentionRate)}</span>
            </div>
            ` : ''}
            ${college.enrollment !== null ? `
            <div class="info-row">
              <span class="info-label">Enrollment</span>
              <span class="info-value">${formatNumber(college.enrollment)}</span>
            </div>
            ` : ''}
            ${college.studentFacultyRatio !== null ? `
            <div class="info-row">
              <span class="info-label">Student:Faculty Ratio</span>
              <span class="info-value">${formatNumber(college.studentFacultyRatio)}:1</span>
            </div>
            ` : ''}
            ${college.medianEarnings !== null ? `
            <div class="info-row">
              <span class="info-label">Median Earnings (10yr)</span>
              <span class="info-value">${formatCurrency(college.medianEarnings)}</span>
            </div>
            ` : ''}
            ${college.campusSetting ? `
            <div class="info-row">
              <span class="info-label">Campus Setting</span>
              <span class="info-value">${college.campusSetting}</span>
            </div>
            ` : ''}
            ${college.testOptional !== null && college.testOptional !== undefined ? `
            <div class="info-row">
              <span class="info-label">Test Optional</span>
              <span class="info-value">${college.testOptional ? 'Yes' : 'No'}</span>
            </div>
            ` : ''}
            ${college.applicationDeadline ? `
            <div class="info-row">
              <span class="info-label">Application Deadline</span>
              <span class="info-value">${college.applicationDeadline}</span>
            </div>
            ` : ''}
            ${college.applicationFee !== null ? `
            <div class="info-row">
              <span class="info-label">Application Fee</span>
              <span class="info-value">${formatCurrency(college.applicationFee)}</span>
            </div>
            ` : ''}
            ${college.averageFinancialAid !== null ? `
            <div class="info-row">
              <span class="info-label">Avg Financial Aid</span>
              <span class="info-value">${formatCurrency(college.averageFinancialAid)}</span>
            </div>
            ` : ''}
            ${college.percentReceivingAid !== null ? `
            <div class="info-row">
              <span class="info-label">% Receiving Aid</span>
              <span class="info-value">${formatPercent(college.percentReceivingAid)}</span>
            </div>
            ` : ''}
            ${college.transferAcceptanceRate !== null ? `
            <div class="info-row">
              <span class="info-label">Transfer Acceptance Rate</span>
              <span class="info-value">${formatPercent(college.transferAcceptanceRate)}</span>
            </div>
            ` : ''}
            ${college.housingAvailable !== null && college.housingAvailable !== undefined ? `
            <div class="info-row">
              <span class="info-label">Housing Available</span>
              <span class="info-value">${college.housingAvailable ? 'Yes' : 'No'}</span>
            </div>
            ` : ''}
            ${college.popularMajors ? `
            <div class="info-row">
              <span class="info-label">Popular Majors</span>
              <span class="info-value" style="text-align: left;">${college.popularMajors}</span>
            </div>
            ` : ''}
            </div>
          </div>

          <div class="college-actions" style="margin-top: 0.75rem; display: flex; gap: 0.5rem; align-items: center;">
            <button class="btn btn-secondary" onclick="saveCollege('${college.id}', event)" style="display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
              <span>${isSaved ? 'Unsave' : 'Save'}</span>
              <img src="/media/icons/${isSaved ? 'StarFull256x256' : 'Star256x256'}.png" alt="${isSaved ? 'Saved' : 'Save'}" style="width: 20px; height: 20px;">
            </button>
            ${college.url ? `
            <button class="btn btn-secondary" onclick="window.open('${college.url}', '_blank')">Visit Website</button>
            ` : ''}
          </div>
        `;
        
        container.appendChild(card);
      });

      // Pagination controls
      if (totalPages > 1) {
        paginationEl.style.display = 'flex';
        paginationEl.innerHTML = `
          <button onclick="changePage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>
            Previous
          </button>
          <span class="pagination-info">Page ${currentPage} of ${totalPages}</span>
          <button onclick="changePage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>
            Next
          </button>
        `;
      } else {
        paginationEl.style.display = 'none';
      }
    }

    function changePage(page) {
      const totalPages = Math.ceil(filteredColleges.length / perPage);
      if (page >= 1 && page <= totalPages) {
        currentPage = page;
        displayColleges();
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }
    }

    function toggleCollegeDetails(collegeId) {
      const toggle = document.getElementById(`toggle-${collegeId}`);
      const content = document.getElementById(`content-${collegeId}`);
      
      if (toggle && content) {
        const isExpanded = toggle.classList.contains('expanded');
        
        if (isExpanded) {
          toggle.classList.remove('expanded');
          content.classList.remove('expanded');
        } else {
          toggle.classList.add('expanded');
          content.classList.add('expanded');
        }
      }
    }

    function saveCollege(collegeId, event) {
      const college = allColleges.find(c => c.id === collegeId);
      if (!college) return;
      
      const isSaved = SavedColleges.isSaved(collegeId);
      
      if (isSaved) {
        SavedColleges.remove(collegeId);
        showNotification(`${college.name} removed from saved`, 'info');
        displayColleges(); // Only refresh if unsave was successful
      } else {
        const success = SavedColleges.add(college);
        if (success) {
        showNotification(`${college.name} saved!`, 'success');
          displayColleges(); // Only refresh if save was successful
        } else {
          showNotification('Maximum of 5 saved colleges reached. Remove one to save another.', 'error');
          // Force button to stay in default state - prevent hover/active styles
          if (event && event.target) {
            const clickedButton = event.target.closest('button');
            if (clickedButton) {
              // Remove focus immediately
              clickedButton.blur();
              // Add class to prevent hover effect
              clickedButton.classList.add('no-hover');
              // Force default styles with inline CSS to override hover state
              const lightMint = getComputedStyle(document.documentElement).getPropertyValue('--light-mint') || '#e8f5e9';
              const primaryGreen = getComputedStyle(document.documentElement).getPropertyValue('--primary-green') || '#0d8c79';
              clickedButton.style.setProperty('background', lightMint, 'important');
              clickedButton.style.setProperty('color', primaryGreen, 'important');
              // Keep the no-hover class to prevent future hover effects
              setTimeout(() => {
                // Re-apply default styles after a moment to ensure they stick
                clickedButton.style.setProperty('background', lightMint, 'important');
                clickedButton.style.setProperty('color', primaryGreen, 'important');
              }, 50);
            }
          }
          // Prevent default behavior and stop propagation
          if (event) {
            event.preventDefault();
            event.stopPropagation();
          }
          // Don't refresh display - button stays in "Save" state
          return;
        }
      }
    }

    function viewCollegeDetails(collegeId) {
      const college = allColleges.find(c => c.id === collegeId);
      if (!college) return;

      const formatNumber = (num) => num !== null && num !== undefined && num !== '' ? num.toLocaleString() : 'N/A';
      const formatCurrency = (num) => num !== null && num !== undefined && num !== '' ? '$' + num.toLocaleString() : 'N/A';
      const formatPercent = (num) => num !== null && num !== undefined && num !== '' ? (num * 100).toFixed(1) + '%' : 'N/A';

      let details = `${college.name}\n\n`;
      details += `Location: ${college.location || 'N/A'}\n`;
      details += `Type: ${college.type || 'N/A'}\n`;
      details += `Size: ${college.size || 'N/A'}\n`;
      details += `Region: ${college.region || 'N/A'}\n`;
      if (college.acceptanceRate !== null) details += `Acceptance Rate: ${formatPercent(college.acceptanceRate)}\n`;
      if (college.satAverage !== null) details += `Average SAT: ${formatNumber(college.satAverage)}\n`;
      if (college.actMidpoint !== null) details += `Average ACT: ${formatNumber(college.actMidpoint)}\n`;
      if (college.tuitionInState !== null) details += `In-State Tuition: ${formatCurrency(college.tuitionInState)}\n`;
      if (college.tuitionOutState !== null) details += `Out-of-State Tuition: ${formatCurrency(college.tuitionOutState)}\n`;
      if (college.graduationRate !== null) details += `Graduation Rate: ${formatPercent(college.graduationRate)}\n`;
      if (college.enrollment !== null) details += `Enrollment: ${formatNumber(college.enrollment)}\n`;
      if (college.popularMajors) details += `\nPopular Majors: ${college.popularMajors}\n`;
      if (college.medianEarnings !== null) details += `Median Earnings (10 years): ${formatCurrency(college.medianEarnings)}\n`;
      if (college.campusSetting) details += `Campus Setting: ${college.campusSetting}\n`;
      
      // Calculate admission odds
      let oddsText;
      if (studentRating !== null && studentRating !== undefined && college.rating !== null && college.rating !== undefined) {
        const odds = getAdmissionOdds(studentRating, college.rating, college.acceptanceRate);
        oddsText = `${odds}%`;
      } else {
        oddsText = 'N/A (Complete your profile to see admission odds)';
      }
      details += `\n\nYour Admission Odds: ${oddsText}`;

      alert(details);
    }
  </script>
  <script src="/js/auth.js"></script>
  <script>
    function handleSignOut() {
      signOut();
      window.location.href = '/pages/login.html';
    }
  </script>
</body>
</html>
