<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="AI Counselor - Path Pal">
  <title>AI Counselor - Path Pal</title>
  <link rel="manifest" href="/manifest.json">
  <link rel="stylesheet" href="/css/style.css">
  <meta name="theme-color" content="#0d8c79">
  <style>
    html, body {
      height: 100%;
      overflow: hidden;
      margin: 0;
      padding: 0;
    }
    body {
      display: flex;
      flex-direction: column;
      margin: 0;
      padding: 0;
    }
    main {
      flex: 1;
      overflow: hidden;
      margin: 0;
      padding: 0;
    }
    /* Make nav overlay flushly over entire page, but below header */
    nav {
      height: calc(100vh - 70px) !important;
      top: 70px !important;
      z-index: 10000 !important;
    }
    /* Ensure header is above main content */
    header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 9999;
    }
    .chat-messages {
      scroll-behavior: smooth;
    }
    .message {
      margin-bottom: 1rem;
      padding: 1rem;
      border-radius: 12px;
      max-width: 85%;
      width: fit-content;
      word-wrap: break-word;
    }
    .chat-messages .message:last-child {
      margin-bottom: 0;
    }
    .message.user {
      background: var(--primary-green);
      color: var(--white);
      margin-left: auto;
      text-align: right;
    }
    .message.ai {
      background: var(--white);
      color: var(--text-dark);
      border: 1px solid var(--border-color);
    }
    /* Smooth transitions for quick questions popup */
    #quick-questions-popup {
      transition: opacity 0.3s ease, transform 0.3s ease;
      transform: translateY(10px);
      opacity: 0;
    }
    #quick-questions-popup.show {
      opacity: 1;
      transform: translateY(0);
    }
  </style>
</head>
<body>
  <div class="desktop-message">
    <h1><img src="/media/icons/Mobile256x256.png" alt="Mobile" style="width: 48px; height: 48px; vertical-align: middle; margin-right: 0.5rem;"> Mobile App Required</h1>
    <p>Path Pal is designed for mobile devices. Please open this site on your mobile phone or tablet.</p>
  </div>

  <header>
    <div class="header-content container">
      <div class="logo">
        <a href="/index.html" style="display: flex; align-items: center; gap: 0.5rem; text-decoration: none; color: inherit;">
          <img src="/media/logo/logo64x64.png" alt="Path Pal Logo">
          <h1>Path Pal</h1>
        </a>
      </div>
      <button class="menu-toggle" aria-label="Toggle menu"><img src="/media/icons/Hamburger128x128.png" alt="Menu" style="width: 24px; height: 24px;"></button>
    </div>
  </header>

  <nav>
    <ul>
      <li><a href="/index.html"><img src="/media/icons/Home256x256.png" alt="Home" class="nav-icon"> Home</a></li>
      <li><a href="/profile.html"><img src="/media/icons/Profile256x256.png" alt="Profile" class="nav-icon"> My Profile</a></li>
      <li><a href="/odds.html"><img src="/media/icons/Odds256x256.png" alt="Admissions Odds" class="nav-icon"> Admissions Odds</a></li>
      <li><a href="/simulator.html"><img src="/media/icons/WhatIf256x256.png" alt="What If" class="nav-icon"> "What If" Simulator</a></li>
      <li><a href="/explorer.html"><img src="/media/icons/Search256x256.png" alt="College Explorer" class="nav-icon"> College Explorer</a></li>
      <li><a href="/career.html"><img src="/media/icons/DollarSign256x256.png" alt="Career & Salary Paths" class="nav-icon"> Career & Salary Paths</a></li>
      <li><a href="/activities.html"><img src="/media/icons/Activity256x256.png" alt="Activities" class="nav-icon"> Activity & Internship Recs</a></li>
      <li><a href="/planner.html"><img src="/media/icons/Calender256x256.png" alt="4-Year Planner" class="nav-icon"> 4-Year Planner</a></li>
      <li><a href="/messages.html" class="active"><img src="/media/icons/Chat256x256.png" alt="AI Counselor" class="nav-icon"> AI Counselor</a></li>
      <li><a href="/saved.html"><img src="/media/icons/Star256x256.png" alt="Saved Colleges" class="nav-icon"> Saved Colleges</a></li>
      <li><a href="#" onclick="handleSignOut(); return false;"><img src="/media/icons/SignOut256x256.png" alt="Sign Out" class="nav-icon"> Sign Out</a></li>
      <li><a href="https://forms.gle/ULMYUSDifpanJ9KMA" target="_blank"><img src="/media/icons/Feedback256x256.png" alt="Feedback" class="nav-icon"> Feedback</a></li>
    </ul>
  </nav>

  <main style="position: fixed; top: 70px; bottom: 0; left: 0; right: 0; background: var(--light-mint); display: flex; flex-direction: column; margin: 0; padding: 0;">
    <!-- Chat Header with Reload Button -->
    <div style="flex-shrink: 0; display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: var(--white); border-bottom: 1px solid var(--border-color); margin: 0;">
      <h2 style="color: var(--primary-green); margin: 0;">AI College Counselor</h2>
      <button onclick="reloadChat()" style="background: var(--light-mint); border: 2px solid var(--primary-green); cursor: pointer; padding: 0.5rem; display: flex; align-items: center; justify-content: center; border-radius: 50%; width: 40px; height: 40px; margin: 0;" title="Reload Chat">
        <img src="/media/icons/Reload256x256.png" alt="Reload" style="width: 20px; height: 20px;" onerror="this.style.display='none'; this.nextElementSibling.style.display='inline';">
        <span style="display: none; font-size: 1.2rem; color: var(--primary-green);">↻</span>
      </button>
    </div>

    <!-- Chat Messages Area - Takes remaining space -->
    <div id="chat-messages" style="flex: 1; overflow-y: auto; padding: 1rem; background: var(--light-mint); margin: 0; min-height: 0;">
      <div class="message ai">
        <strong>Path Pal:</strong> Hello! I'm your 24/7 personal counselor. Ask me anything about college admissions, course planning, career advice, or anything else related to your college path. How can I help you today?
      </div>
    </div>

    <!-- Quick Questions Popup -->
    <div id="quick-questions-popup" style="position: fixed; bottom: 80px; left: 0.5rem; right: 0.5rem; background: var(--white); border: 2px solid var(--primary-green); border-radius: 12px; padding: 1rem; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1000; max-height: 300px; overflow-y: auto; pointer-events: none; margin: 0;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
        <h3 style="margin: 0; color: var(--primary-green);">Quick Questions</h3>
        <button onclick="toggleQuickQuestions()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-light); margin: 0; padding: 0;">×</button>
      </div>
      <div style="display: flex; flex-direction: column; gap: 0.5rem; margin: 0;">
        <button class="btn btn-secondary" onclick="askQuickQuestion('What courses should I take next semester?')" style="text-align: left; justify-content: flex-start; margin: 0;">
          <img src="/media/icons/Book256x256.png" alt="Book" style="width: 20px; height: 20px; vertical-align: middle; margin-right: 0.5rem;"> Course Recommendations
        </button>
        <button class="btn btn-secondary" onclick="askQuickQuestion('How can I improve my admission odds?')" style="text-align: left; justify-content: flex-start; margin: 0;">
          <img src="/media/icons/Chart256x256.png" alt="Chart" style="width: 20px; height: 20px; vertical-align: middle; margin-right: 0.5rem;"> Improve Admission Odds
        </button>
        <button class="btn btn-secondary" onclick="askQuickQuestion('What activities should I focus on?')" style="text-align: left; justify-content: flex-start; margin: 0;">
          <img src="/media/icons/Activity256x256.png" alt="Activity" style="width: 20px; height: 20px; vertical-align: middle; margin-right: 0.5rem;"> Activity Suggestions
        </button>
        <button class="btn btn-secondary" onclick="askQuickQuestion('How should I prepare for college applications?')" style="text-align: left; justify-content: flex-start; margin: 0;">
          <img src="/media/icons/Check256x256.png" alt="Check" style="width: 20px; height: 20px; vertical-align: middle; margin-right: 0.5rem;"> Application Prep
        </button>
      </div>
    </div>

    <!-- Chat Input Container - Fixed at bottom -->
    <div style="flex-shrink: 0; padding: 1rem; background: var(--white); border-top: 1px solid var(--border-color); margin: 0;">
      <div style="display: flex; align-items: center; gap: 0.5rem; margin: 0;">
        <button onclick="toggleQuickQuestions()" style="background: var(--light-mint); border: 2px solid var(--primary-green); border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0; padding: 0; margin: 0;" title="Quick Questions">
          <img src="/media/icons/Question256x256.png" alt="Quick Questions" style="width: 24px; height: 24px;" onerror="this.style.display='none'; this.nextElementSibling.style.display='inline';">
          <span style="display: none; font-size: 1.2rem; color: var(--primary-green); font-weight: bold;">?</span>
        </button>
        <form id="chat-form" onsubmit="sendMessage(event)" style="flex: 1; display: flex; gap: 0.5rem; margin: 0;">
          <input 
            type="text" 
            id="message-input" 
            placeholder="Ask me anything..." 
            required
            autocomplete="off"
            maxlength="2000"
            style="flex: 1; padding: 0.75rem 1rem; border: 2px solid var(--border-color); border-radius: 25px; font-size: 1rem; font-family: 'Arvo', serif; margin: 0;"
          />
          <button type="submit" style="padding: 0.75rem 1.5rem; background: var(--primary-green); color: var(--white); border: none; border-radius: 25px; cursor: pointer; font-family: 'Arvo', serif; font-weight: bold; white-space: nowrap; margin: 0;">Send</button>
        </form>
      </div>
    </div>
  </main>

  <footer style="display: none;">
    <div class="container">
      <p>&copy; 2025 Path Pal. v1.09.2</p>
    </div>
  </footer>

  <script src="/js/api.js"></script>
  <script src="/js/app.js"></script>
  <script>
    let chatHistory = [];

    document.addEventListener('DOMContentLoaded', () => {
      // Load chat history
      chatHistory = Storage.get('chatHistory', []);
      loadChatHistory();
      
      // Check for question parameter in URL
      const urlParams = new URLSearchParams(window.location.search);
      const question = urlParams.get('question');
      if (question) {
        // Decode and set the question in the input
        const decodedQuestion = decodeURIComponent(question);
        const input = document.getElementById('message-input');
        input.value = decodedQuestion;
        
        // Auto-submit after a short delay to ensure page is loaded
        setTimeout(() => {
          document.getElementById('chat-form').dispatchEvent(new Event('submit'));
        }, 500);
      } else {
        // Focus input if no question
        document.getElementById('message-input').focus();
      }
    });

    function loadChatHistory() {
      const container = document.getElementById('chat-messages');
      
      // Clear except welcome message
      container.innerHTML = '<div class="message ai"><strong>Path Pal:</strong> Hello! I\'m your 24/7 personal counselor. Ask me anything about college admissions, course planning, career advice, or anything else related to your college path. How can I help you today?</div>';
      
      // Load saved messages
      chatHistory.forEach(msg => {
        addMessageToChat(msg.text, msg.sender, false);
      });
      
      // Scroll to bottom
      container.scrollTop = container.scrollHeight;
    }

    async function sendMessage(event) {
      event.preventDefault();
      
      const input = document.getElementById('message-input');
      const message = input.value.trim();
      
      if (!message) return;
      
      // Clear input
      input.value = '';
      
      // Add user message
      addMessageToChat(message, 'user', true);
      
      // Show loading with animated ellipsis
      const loadingId = addLoadingMessage();
      
      try {
        // Get user profile for context
        const profile = await UserProfile.get();
        const context = [
          {
            role: 'system',
            content: `You are a helpful college admissions counselor and academic advisor. IMPORTANT: You ONLY answer questions related to college admissions, academic planning, course selection, standardized tests (SAT/ACT), college applications, financial aid, scholarships, career planning related to education, and academic advice. If asked about topics unrelated to college or education, politely decline and redirect to college-related topics. Keep all responses concise and to the point (2-4 sentences maximum unless the question requires more detail). The student's profile: Grade: ${profile.grade || 'not set'}, GPA: ${profile.gpa || 'not set'}, SAT: ${profile.sat || 'not set'}, ACT: ${profile.act || 'not set'}, Majors: ${(profile.majors || []).join(', ') || 'not specified'}, Career Goals: ${profile.careerGoals || 'not specified'}. Provide personalized, actionable advice.`
          },
          ...chatHistory.slice(-4).map(msg => ({
            role: msg.sender === 'user' ? 'user' : 'assistant',
            content: msg.text
          }))
        ];
        
        const response = await sendChatMessage(message, context);
        
        // Remove loading message
        removeMessage(loadingId);
        
        // Add AI response
        addMessageToChat(response.message, 'ai', true);
        
        // Save to history
        chatHistory.push({ text: message, sender: 'user' });
        chatHistory.push({ text: response.message, sender: 'ai' });
        
        // Keep last 20 messages
        if (chatHistory.length > 20) {
          chatHistory = chatHistory.slice(-20);
        }
        
        Storage.set('chatHistory', chatHistory);
      } catch (error) {
        removeMessage(loadingId);
        addMessageToChat('Sorry, I encountered an error. Please try again later.', 'ai', true);
        console.error('Chat error:', error);
      }
    }

    function addLoadingMessage() {
      const container = document.getElementById('chat-messages');
      const messageDiv = document.createElement('div');
      const messageId = 'msg-' + Date.now() + '-' + Math.random();
      messageDiv.id = messageId;
      messageDiv.className = 'message ai';
      
      const textSpan = document.createElement('span');
      textSpan.id = messageId + '-text';
      textSpan.textContent = 'Thinking'; // Set initial text immediately
      messageDiv.innerHTML = '<strong>Path Pal:</strong> ';
      messageDiv.appendChild(textSpan);
      
      container.appendChild(messageDiv);
      container.scrollTop = container.scrollHeight;
      
      // Animate ellipsis
      let dots = 1;
      const loadingInterval = setInterval(() => {
        dots = (dots % 3) + 1;
        textSpan.textContent = 'Thinking' + '.'.repeat(dots);
      }, 500);
      
      // Store interval ID so we can clear it later
      messageDiv.dataset.intervalId = loadingInterval;
      
      return messageId;
    }

    function addMessageToChat(text, sender, scroll = false) {
      const container = document.getElementById('chat-messages');
      const messageDiv = document.createElement('div');
      const messageId = 'msg-' + Date.now() + '-' + Math.random();
      messageDiv.id = messageId;
      messageDiv.className = `message ${sender}`;
      
      if (sender === 'user') {
        messageDiv.innerHTML = `<strong>You:</strong> ${text}`;
      } else {
        messageDiv.innerHTML = `<strong>Path Pal:</strong> ${text}`;
      }
      
      container.appendChild(messageDiv);
      
      if (scroll) {
        container.scrollTop = container.scrollHeight;
      }
      
      return messageId;
    }

    function removeMessage(messageId) {
      const message = document.getElementById(messageId);
      if (message) {
        // Clear any animation interval if it exists
        if (message.dataset.intervalId) {
          clearInterval(parseInt(message.dataset.intervalId));
        }
        message.remove();
      }
    }

    function askQuickQuestion(question) {
      document.getElementById('message-input').value = question;
      toggleQuickQuestions(); // Hide the popup
      document.getElementById('chat-form').dispatchEvent(new Event('submit'));
    }

    function toggleQuickQuestions() {
      const popup = document.getElementById('quick-questions-popup');
      if (popup.classList.contains('show')) {
        // Hide with smooth transition
        popup.classList.remove('show');
        setTimeout(() => {
          popup.style.pointerEvents = 'none';
        }, 300);
      } else {
        // Show with smooth transition
        popup.style.pointerEvents = 'auto';
        setTimeout(() => {
          popup.classList.add('show');
        }, 10);
      }
    }

    // Close quick questions when clicking outside
    document.addEventListener('click', (e) => {
      const popup = document.getElementById('quick-questions-popup');
      const questionBtn = e.target.closest('button[onclick="toggleQuickQuestions()"]');
      if (popup && popup.classList.contains('show') && !popup.contains(e.target) && !questionBtn) {
        popup.classList.remove('show');
        setTimeout(() => {
          popup.style.pointerEvents = 'none';
        }, 300);
      }
    });

    function reloadChat() {
      chatHistory = [];
      Storage.set('chatHistory', []);
      loadChatHistory();
    }
  </script>
  <script src="/js/auth.js"></script>
  <script>
    function handleSignOut() {
      signOut();
      window.location.href = '/pages/login.html';
    }
  </script>
</body>
</html>

