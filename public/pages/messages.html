<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="AI Counselor - Path Pal">
  <title>AI Counselor - Path Pal</title>
  <link rel="manifest" href="/manifest.json">
  <link rel="stylesheet" href="/css/style.css">
  <meta name="theme-color" content="#0d8c79">
</head>
<body>
  <div class="desktop-message">
    <h1><img src="/media/icons/Mobile256x256.png" alt="Mobile" style="width: 48px; height: 48px; vertical-align: middle; margin-right: 0.5rem;"> Mobile App Required</h1>
    <p>Path Pal is designed for mobile devices. Please open this site on your mobile phone or tablet.</p>
  </div>

  <header>
    <div class="header-content container">
      <div class="logo">
        <a href="/index.html" style="display: flex; align-items: center; gap: 0.5rem; text-decoration: none; color: inherit;">
          <img src="/media/logo/logo64x64.png" alt="Path Pal Logo">
          <h1>Path Pal</h1>
        </a>
      </div>
      <button class="menu-toggle" aria-label="Toggle menu"><img src="/media/icons/Hamburger128x128.png" alt="Menu" style="width: 24px; height: 24px;"></button>
    </div>
  </header>

  <nav>
    <ul>
      <li><a href="/index.html"><img src="/media/icons/Home256x256.png" alt="Home" class="nav-icon"> Home</a></li>
      <li><a href="/profile.html"><img src="/media/icons/Profile256x256.png" alt="Profile" class="nav-icon"> My Profile</a></li>
      <li><a href="/odds.html"><img src="/media/icons/Odds256x256.png" alt="Admissions Odds" class="nav-icon"> Admissions Odds</a></li>
      <li><a href="/simulator.html"><img src="/media/icons/WhatIf256x256.png" alt="What If" class="nav-icon"> "What If" Simulator</a></li>
      <li><a href="/explorer.html"><img src="/media/icons/Search256x256.png" alt="College Explorer" class="nav-icon"> College Explorer</a></li>
      <li><a href="/career.html"><img src="/media/icons/DollarSign256x256.png" alt="Career & Salary Paths" class="nav-icon"> Career & Salary Paths</a></li>
      <li><a href="/activities.html"><img src="/media/icons/Activity256x256.png" alt="Activities" class="nav-icon"> Activity & Internship Recs</a></li>
      <li><a href="/planner.html"><img src="/media/icons/Calender256x256.png" alt="4-Year Planner" class="nav-icon"> 4-Year Planner</a></li>
      <li><a href="/messages.html" class="active"><img src="/media/icons/Chat256x256.png" alt="AI Counselor" class="nav-icon"> AI Counselor</a></li>
      <li><a href="/saved.html"><img src="/media/icons/Star256x256.png" alt="Saved Colleges" class="nav-icon"> Saved Colleges</a></li>
    </ul>
  </nav>

  <main>
    <div class="container">
      <h2 style="color: var(--primary-green); margin: 1rem 0;">AI College Counselor</h2>

      <!-- Chat Interface -->
      <div class="chat-container">
        <div class="chat-messages" id="chat-messages">
          <div class="message ai">
            <strong>Path Pal AI Advisor:</strong> Hello! I'm your 24/7 personal counselor. Ask me anything about college admissions, course planning, career advice, or anything else related to your college path. How can I help you today?
          </div>
        </div>

        <div class="chat-input-container">
          <form class="chat-input-form" id="chat-form" onsubmit="sendMessage(event)">
            <input 
              type="text" 
              id="message-input" 
              placeholder="Ask me anything..." 
              required
              autocomplete="off"
            />
            <button type="submit">Send</button>
          </form>
        </div>
      </div>

      <!-- Quick Questions -->
      <div class="card" style="margin-top: 1rem;">
        <h3>Quick Questions</h3>
        <div style="display: flex; flex-direction: column; gap: 0.5rem;">
          <button class="btn btn-secondary" onclick="askQuickQuestion('What courses should I take next semester?')">
            <img src="/media/icons/Book256x256.png" alt="Book" style="width: 20px; height: 20px; vertical-align: middle; margin-right: 0.5rem;"> Course Recommendations
          </button>
          <button class="btn btn-secondary" onclick="askQuickQuestion('How can I improve my admission odds?')">
            <img src="/media/icons/Chart256x256.png" alt="Chart" style="width: 20px; height: 20px; vertical-align: middle; margin-right: 0.5rem;"> Improve Admission Odds
          </button>
          <button class="btn btn-secondary" onclick="askQuickQuestion('What activities should I focus on?')">
            <img src="/media/icons/Activity256x256.png" alt="Activity" style="width: 20px; height: 20px; vertical-align: middle; margin-right: 0.5rem;"> Activity Suggestions
          </button>
          <button class="btn btn-secondary" onclick="askQuickQuestion('How should I prepare for college applications?')">
            <img src="/media/icons/Check256x256.png" alt="Check" style="width: 20px; height: 20px; vertical-align: middle; margin-right: 0.5rem;"> Application Prep
          </button>
        </div>
      </div>
    </div>
  </main>

  <footer>
    <div class="container">
      <p>&copy; 2025 Path Pal. v1.07</p>
    </div>
  </footer>

  <script src="/js/api.js"></script>
  <script src="/js/app.js"></script>
  <script>
    let chatHistory = [];

    document.addEventListener('DOMContentLoaded', () => {
      // Load chat history
      chatHistory = Storage.get('chatHistory', []);
      loadChatHistory();
      
      // Check for question parameter in URL
      const urlParams = new URLSearchParams(window.location.search);
      const question = urlParams.get('question');
      if (question) {
        // Decode and set the question in the input
        const decodedQuestion = decodeURIComponent(question);
        const input = document.getElementById('message-input');
        input.value = decodedQuestion;
        
        // Auto-submit after a short delay to ensure page is loaded
        setTimeout(() => {
          document.getElementById('chat-form').dispatchEvent(new Event('submit'));
        }, 500);
      } else {
        // Focus input if no question
        document.getElementById('message-input').focus();
      }
    });

    function loadChatHistory() {
      const container = document.getElementById('chat-messages');
      
      // Clear except welcome message
      container.innerHTML = '<div class="message ai"><strong>Path Pal AI Advisor:</strong> Hello! I\'m your 24/7 personal counselor. Ask me anything about college admissions, course planning, career advice, or anything else related to your college path. How can I help you today?</div>';
      
      // Load saved messages
      chatHistory.forEach(msg => {
        addMessageToChat(msg.text, msg.sender, false);
      });
      
      // Scroll to bottom
      container.scrollTop = container.scrollHeight;
    }

    async function sendMessage(event) {
      event.preventDefault();
      
      const input = document.getElementById('message-input');
      const message = input.value.trim();
      
      if (!message) return;
      
      // Clear input
      input.value = '';
      
      // Add user message
      addMessageToChat(message, 'user', true);
      
      // Show loading with animated ellipsis
      const loadingId = addLoadingMessage();
      
      try {
        // Get user profile for context
        const profile = await UserProfile.get();
        const context = [
          {
            role: 'system',
            content: `You are a helpful college admissions counselor and academic advisor. The student's profile: Grade: ${profile.grade || 'not set'}, GPA: ${profile.gpa || 'not set'}, SAT: ${profile.sat || 'not set'}, ACT: ${profile.act || 'not set'}, Majors: ${(profile.majors || []).join(', ') || 'not specified'}, Career Goals: ${profile.careerGoals || 'not specified'}. Provide personalized, actionable advice.`
          },
          ...chatHistory.slice(-4).map(msg => ({
            role: msg.sender === 'user' ? 'user' : 'assistant',
            content: msg.text
          }))
        ];
        
        const response = await sendChatMessage(message, context);
        
        // Remove loading message
        removeMessage(loadingId);
        
        // Add AI response
        addMessageToChat(response.message, 'ai', true);
        
        // Save to history
        chatHistory.push({ text: message, sender: 'user' });
        chatHistory.push({ text: response.message, sender: 'ai' });
        
        // Keep last 20 messages
        if (chatHistory.length > 20) {
          chatHistory = chatHistory.slice(-20);
        }
        
        Storage.set('chatHistory', chatHistory);
      } catch (error) {
        removeMessage(loadingId);
        addMessageToChat('Sorry, I encountered an error. Please try again later.', 'ai', true);
        console.error('Chat error:', error);
      }
    }

    function addLoadingMessage() {
      const container = document.getElementById('chat-messages');
      const messageDiv = document.createElement('div');
      const messageId = 'msg-' + Date.now() + '-' + Math.random();
      messageDiv.id = messageId;
      messageDiv.className = 'message ai';
      
      const textSpan = document.createElement('span');
      textSpan.id = messageId + '-text';
      messageDiv.innerHTML = '<strong>Path Pal AI Advisor:</strong> ';
      messageDiv.appendChild(textSpan);
      
      container.appendChild(messageDiv);
      container.scrollTop = container.scrollHeight;
      
      // Animate ellipsis
      let dots = 0;
      const loadingInterval = setInterval(() => {
        dots = (dots % 3) + 1;
        textSpan.textContent = 'Thinking' + '.'.repeat(dots);
      }, 500);
      
      // Store interval ID so we can clear it later
      messageDiv.dataset.intervalId = loadingInterval;
      
      return messageId;
    }

    function addMessageToChat(text, sender, scroll = false) {
      const container = document.getElementById('chat-messages');
      const messageDiv = document.createElement('div');
      const messageId = 'msg-' + Date.now() + '-' + Math.random();
      messageDiv.id = messageId;
      messageDiv.className = `message ${sender}`;
      
      if (sender === 'user') {
        messageDiv.innerHTML = `<strong>You:</strong> ${text}`;
      } else {
        messageDiv.innerHTML = `<strong>Path Pal AI Advisor:</strong> ${text}`;
      }
      
      container.appendChild(messageDiv);
      
      if (scroll) {
        container.scrollTop = container.scrollHeight;
      }
      
      return messageId;
    }

    function removeMessage(messageId) {
      const message = document.getElementById(messageId);
      if (message) {
        // Clear any animation interval if it exists
        if (message.dataset.intervalId) {
          clearInterval(parseInt(message.dataset.intervalId));
        }
        message.remove();
      }
    }

    function askQuickQuestion(question) {
      document.getElementById('message-input').value = question;
      document.getElementById('chat-form').dispatchEvent(new Event('submit'));
    }
  </script>
</body>
</html>

